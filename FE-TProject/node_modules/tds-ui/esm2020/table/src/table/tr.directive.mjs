import { ContentChildren, Directive, Input, Optional } from '@angular/core';
import { combineLatest, merge, ReplaySubject, Subject } from 'rxjs';
import { map, mergeMap, startWith, switchMap, takeUntil } from 'rxjs/operators';
import { TDSCellFixedDirective } from '../cell/cell-fixed.directive';
import { TDSThMeasureDirective } from '../cell/th-measure.directive';
import * as i0 from "@angular/core";
import * as i1 from "../table-style.service";
export class TDSTrDirective {
    constructor(tdsTableStyleService) {
        this.tdsTableStyleService = tdsTableStyleService;
        this.isTrHeader = false;
        this.destroy$ = new Subject();
        this.listOfFixedColumns$ = new ReplaySubject(1);
        this.listOfColumns$ = new ReplaySubject(1);
        this.listOfFixedColumnsChanges$ = this.listOfFixedColumns$.pipe(switchMap(list => merge(...[this.listOfFixedColumns$, ...list.map((c) => c.changes$)]).pipe(mergeMap(() => this.listOfFixedColumns$))), takeUntil(this.destroy$));
        this.listOfFixedLeftColumnChanges$ = this.listOfFixedColumnsChanges$.pipe(map(list => list.filter(item => item.tdsLeft !== false)));
        this.listOfFixedRightColumnChanges$ = this.listOfFixedColumnsChanges$.pipe(map(list => list.filter(item => item.tdsRight !== false)));
        this.listOfColumnsChanges$ = this.listOfColumns$.pipe(switchMap(list => merge(...[this.listOfColumns$, ...list.map((c) => c.changes$)]).pipe(mergeMap(() => this.listOfColumns$))), takeUntil(this.destroy$));
        this.isInsideTable = false;
        this.isInsideTable = !!tdsTableStyleService;
    }
    ngAfterContentInit() {
        if (this.tdsTableStyleService) {
            this.listOfCellFixedDirective.changes
                .pipe(startWith(this.listOfCellFixedDirective), takeUntil(this.destroy$))
                .subscribe(this.listOfFixedColumns$);
            this.listOfNzThDirective.changes
                .pipe(startWith(this.listOfNzThDirective), takeUntil(this.destroy$))
                .subscribe(this.listOfColumns$);
            /** set last left and first right **/
            this.listOfFixedLeftColumnChanges$.subscribe(listOfFixedLeft => {
                listOfFixedLeft.forEach(cell => cell.setIsLastLeft(cell === listOfFixedLeft[listOfFixedLeft.length - 1]));
            });
            this.listOfFixedRightColumnChanges$.subscribe(listOfFixedRight => {
                listOfFixedRight.forEach(cell => cell.setIsFirstRight(cell === listOfFixedRight[0]));
            });
            /** calculate fixed tdsLeft and tdsRight **/
            combineLatest([this.tdsTableStyleService.listOfListOfThWidth$, this.listOfFixedLeftColumnChanges$])
                .pipe(takeUntil(this.destroy$))
                .subscribe(([listOfAutoWidth, listOfLeftCell]) => {
                listOfLeftCell.forEach((cell, index) => {
                    if (cell.isAutoLeft) {
                        const currentArray = listOfLeftCell.slice(0, index);
                        const count = currentArray.reduce((pre, cur) => pre + (cur.colspan || cur.colSpan || 1), 0);
                        const width = listOfAutoWidth.slice(0, count).reduce((pre, cur) => pre + cur, 0);
                        cell.setAutoLeftWidth(`${width}px`);
                    }
                });
            });
            combineLatest([this.tdsTableStyleService.listOfListOfThWidth$, this.listOfFixedRightColumnChanges$])
                .pipe(takeUntil(this.destroy$))
                .subscribe(([listOfAutoWidth, listOfRightCell]) => {
                listOfRightCell.forEach((_, index) => {
                    const cell = listOfRightCell[listOfRightCell.length - index - 1];
                    if (cell.isAutoRight) {
                        const currentArray = listOfRightCell.slice(listOfRightCell.length - index, listOfRightCell.length);
                        const count = currentArray.reduce((pre, cur) => pre + (cur.colspan || cur.colSpan || 1), 0);
                        const width = listOfAutoWidth
                            .slice(listOfAutoWidth.length - count, listOfAutoWidth.length)
                            .reduce((pre, cur) => pre + cur, 0);
                        cell.setAutoRightWidth(`${width}px`);
                    }
                });
            });
        }
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroy$.complete();
    }
}
TDSTrDirective.ɵfac = function TDSTrDirective_Factory(t) { return new (t || TDSTrDirective)(i0.ɵɵdirectiveInject(i1.TDSTableStyleService, 8)); };
TDSTrDirective.ɵdir = /*@__PURE__*/ i0.ɵɵdefineDirective({ type: TDSTrDirective, selectors: [["tr", 3, "mat-row", "", 3, "mat-header-row", "", 3, "tds-table-measure-row", "", 3, "expand", "", 3, "tds-table-fixed-row", "", 3, "tds-table-thead", ""]], contentQueries: function TDSTrDirective_ContentQueries(rf, ctx, dirIndex) { if (rf & 1) {
        i0.ɵɵcontentQuery(dirIndex, TDSThMeasureDirective, 4);
        i0.ɵɵcontentQuery(dirIndex, TDSCellFixedDirective, 4);
    } if (rf & 2) {
        let _t;
        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.listOfNzThDirective = _t);
        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.listOfCellFixedDirective = _t);
    } }, hostVars: 4, hostBindings: function TDSTrDirective_HostBindings(rf, ctx) { if (rf & 2) {
        i0.ɵɵclassProp("tds-table-row", ctx.isInsideTable)("text-left", ctx.isInsideTable);
    } }, inputs: { isTrHeader: "isTrHeader" } });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(TDSTrDirective, [{
        type: Directive,
        args: [{
                selector: 'tr:not([mat-row]):not([mat-header-row]):not([tds-table-measure-row]):not([expand]):not([tds-table-fixed-row]):not([tds-table-thead])',
                host: {
                    '[class.tds-table-row]': 'isInsideTable',
                    // '[class.border-b]': 'isInsideTable && !isTrHeader',
                    // '[class.border-neutral-2-100]': 'isInsideTable',
                    '[class.text-left]': 'isInsideTable',
                }
            }]
    }], function () { return [{ type: i1.TDSTableStyleService, decorators: [{
                type: Optional
            }] }]; }, { isTrHeader: [{
            type: Input
        }], listOfNzThDirective: [{
            type: ContentChildren,
            args: [TDSThMeasureDirective]
        }], listOfCellFixedDirective: [{
            type: ContentChildren,
            args: [TDSCellFixedDirective]
        }] }); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHIuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvdGRzLXVpL3RhYmxlL3NyYy90YWJsZS90ci5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFvQixlQUFlLEVBQUUsU0FBUyxFQUFHLEtBQUssRUFBYSxRQUFRLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDckgsT0FBTyxFQUFFLGFBQWEsRUFBRSxLQUFLLEVBQWMsYUFBYSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNoRixPQUFPLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRWhGLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ3JFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDhCQUE4QixDQUFDOzs7QUFjckUsTUFBTSxPQUFPLGNBQWM7SUErQnpCLFlBQWdDLG9CQUEwQztRQUExQyx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBOUJqRSxlQUFVLEdBQVcsS0FBSyxDQUFDO1FBRzVCLGFBQVEsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBQy9CLHdCQUFtQixHQUFHLElBQUksYUFBYSxDQUEwQixDQUFDLENBQUMsQ0FBQztRQUNwRSxtQkFBYyxHQUFHLElBQUksYUFBYSxDQUEwQixDQUFDLENBQUMsQ0FBQztRQUN2RSwrQkFBMEIsR0FBd0MsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FDN0YsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQ2YsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBd0IsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FB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b0JBQ3RELG1EQUFtRDtvQkFDbEQsbUJBQW1CLEVBQUUsZUFBZTtpQkFFdEM7YUFDRjs7c0JBZ0NjLFFBQVE7d0JBOUJaLFVBQVU7a0JBQWxCLEtBQUs7WUFDa0MsbUJBQW1CO2tCQUExRCxlQUFlO21CQUFDLHFCQUFxQjtZQUNFLHdCQUF3QjtrQkFBL0QsZUFBZTttQkFBQyxxQkFBcUIiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuaW1wb3J0IHsgQWZ0ZXJDb250ZW50SW5pdCwgQ29udGVudENoaWxkcmVuLCBEaXJlY3RpdmUsICBJbnB1dCwgT25EZXN0cm95LCBPcHRpb25hbCwgUXVlcnlMaXN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IGNvbWJpbmVMYXRlc3QsIG1lcmdlLCBPYnNlcnZhYmxlLCBSZXBsYXlTdWJqZWN0LCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IG1hcCwgbWVyZ2VNYXAsIHN0YXJ0V2l0aCwgc3dpdGNoTWFwLCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBURFNDZWxsRml4ZWREaXJlY3RpdmUgfSBmcm9tICcuLi9jZWxsL2NlbGwtZml4ZWQuZGlyZWN0aXZlJztcclxuaW1wb3J0IHsgVERTVGhNZWFzdXJlRGlyZWN0aXZlIH0gZnJvbSAnLi4vY2VsbC90aC1tZWFzdXJlLmRpcmVjdGl2ZSc7XHJcbmltcG9ydCB7IFREU1RhYmxlU3R5bGVTZXJ2aWNlIH0gZnJvbSAnLi4vdGFibGUtc3R5bGUuc2VydmljZSc7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjpcclxuICAgICd0cjpub3QoW21hdC1yb3ddKTpub3QoW21hdC1oZWFkZXItcm93XSk6bm90KFt0ZHMtdGFibGUtbWVhc3VyZS1yb3ddKTpub3QoW2V4cGFuZF0pOm5vdChbdGRzLXRhYmxlLWZpeGVkLXJvd10pOm5vdChbdGRzLXRhYmxlLXRoZWFkXSknLFxyXG4gIGhvc3Q6IHtcclxuICAgICdbY2xhc3MudGRzLXRhYmxlLXJvd10nOiAnaXNJbnNpZGVUYWJsZScsXHJcbiAgICAvLyAnW2NsYXNzLmJvcmRlci1iXSc6ICdpc0luc2lkZVRhYmxlICYmICFpc1RySGVhZGVyJyxcclxuICAgIC8vICdbY2xhc3MuYm9yZGVyLW5ldXRyYWwtMi0xMDBdJzogJ2lzSW5zaWRlVGFibGUnLFxyXG4gICAgICdbY2xhc3MudGV4dC1sZWZ0XSc6ICdpc0luc2lkZVRhYmxlJywgIFxyXG4gICAgXHJcbiAgfVxyXG59KVxyXG5leHBvcnQgY2xhc3MgVERTVHJEaXJlY3RpdmUgaW1wbGVtZW50cyBBZnRlckNvbnRlbnRJbml0LCBPbkRlc3Ryb3kge1xyXG4gIEBJbnB1dCgpIGlzVHJIZWFkZXIgOmJvb2xlYW4gPWZhbHNlO1xyXG4gIEBDb250ZW50Q2hpbGRyZW4oVERTVGhNZWFzdXJlRGlyZWN0aXZlKSBsaXN0T2ZOelRoRGlyZWN0aXZlITogUXVlcnlMaXN0PFREU1RoTWVhc3VyZURpcmVjdGl2ZT47XHJcbiAgQENvbnRlbnRDaGlsZHJlbihURFNDZWxsRml4ZWREaXJlY3RpdmUpIGxpc3RPZkNlbGxGaXhlZERpcmVjdGl2ZSE6IFF1ZXJ5TGlzdDxURFNDZWxsRml4ZWREaXJlY3RpdmU+O1xyXG4gIHByaXZhdGUgZGVzdHJveSQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xyXG4gIHByaXZhdGUgbGlzdE9mRml4ZWRDb2x1bW5zJCA9IG5ldyBSZXBsYXlTdWJqZWN0PFREU0NlbGxGaXhlZERpcmVjdGl2ZVtdPigxKTtcclxuICBwcml2YXRlIGxpc3RPZkNvbHVtbnMkID0gbmV3IFJlcGxheVN1YmplY3Q8VERTVGhNZWFzdXJlRGlyZWN0aXZlW10+KDEpO1xyXG4gIGxpc3RPZkZpeGVkQ29sdW1uc0NoYW5nZXMkOiBPYnNlcnZhYmxlPFREU0NlbGxGaXhlZERpcmVjdGl2ZVtdPiA9IHRoaXMubGlzdE9mRml4ZWRDb2x1bW5zJC5waXBlKFxyXG4gICAgc3dpdGNoTWFwKGxpc3QgPT5cclxuICAgICAgbWVyZ2UoLi4uW3RoaXMubGlzdE9mRml4ZWRDb2x1bW5zJCwgLi4ubGlzdC5tYXAoKGM6IFREU0NlbGxGaXhlZERpcmVjdGl2ZSkgPT4gYy5jaGFuZ2VzJCldKS5waXBlKFxyXG4gICAgICAgIG1lcmdlTWFwKCgpID0+IHRoaXMubGlzdE9mRml4ZWRDb2x1bW5zJClcclxuICAgICAgKVxyXG4gICAgKSxcclxuICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKVxyXG4gICk7XHJcbiAgbGlzdE9mRml4ZWRMZWZ0Q29sdW1uQ2hhbmdlcyQgPSB0aGlzLmxpc3RPZkZpeGVkQ29sdW1uc0NoYW5nZXMkLnBpcGUoXHJcbiAgICBtYXAobGlzdCA9PiBsaXN0LmZpbHRlcihpdGVtID0+IGl0ZW0udGRzTGVmdCAhPT0gZmFsc2UpKVxyXG4gICk7XHJcbiAgbGlzdE9mRml4ZWRSaWdodENvbHVtbkNoYW5nZXMkID0gdGhpcy5saXN0T2ZGaXhlZENvbHVtbnNDaGFuZ2VzJC5waXBlKFxyXG4gICAgbWFwKGxpc3QgPT4gbGlzdC5maWx0ZXIoaXRlbSA9PiBpdGVtLnRkc1JpZ2h0ICE9PSBmYWxzZSkpXHJcbiAgKTtcclxuICBsaXN0T2ZDb2x1bW5zQ2hhbmdlcyQ6IE9ic2VydmFibGU8VERTVGhNZWFzdXJlRGlyZWN0aXZlW10+ID0gdGhpcy5saXN0T2ZDb2x1bW5zJC5waXBlKFxyXG4gICAgc3dpdGNoTWFwKGxpc3QgPT5cclxuICAgICAgbWVyZ2UoLi4uW3RoaXMubGlzdE9mQ29sdW1ucyQsIC4uLmxpc3QubWFwKChjOiBURFNUaE1lYXN1cmVEaXJlY3RpdmUpID0+IGMuY2hhbmdlcyQpXSkucGlwZShcclxuICAgICAgICBtZXJnZU1hcCgoKSA9PiB0aGlzLmxpc3RPZkNvbHVtbnMkKVxyXG4gICAgICApXHJcbiAgICApLFxyXG4gICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveSQpXHJcbiAgKTtcclxuICBpc0luc2lkZVRhYmxlID0gZmFsc2U7XHJcbiBcclxuICBjb25zdHJ1Y3RvcihAT3B0aW9uYWwoKSBwcml2YXRlIHRkc1RhYmxlU3R5bGVTZXJ2aWNlOiBURFNUYWJsZVN0eWxlU2VydmljZVxyXG4gICkge1xyXG4gICAgdGhpcy5pc0luc2lkZVRhYmxlID0gISF0ZHNUYWJsZVN0eWxlU2VydmljZTtcclxuICAgIFxyXG4gIH1cclxuXHJcbiAgbmdBZnRlckNvbnRlbnRJbml0KCk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMudGRzVGFibGVTdHlsZVNlcnZpY2UpIHtcclxuICAgICAgdGhpcy5saXN0T2ZDZWxsRml4ZWREaXJlY3RpdmUuY2hhbmdlc1xyXG4gICAgICAgIC5waXBlKHN0YXJ0V2l0aCh0aGlzLmxpc3RPZkNlbGxGaXhlZERpcmVjdGl2ZSksIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSlcclxuICAgICAgICAuc3Vic2NyaWJlKHRoaXMubGlzdE9mRml4ZWRDb2x1bW5zJCk7XHJcbiAgICAgIHRoaXMubGlzdE9mTnpUaERpcmVjdGl2ZS5jaGFuZ2VzXHJcbiAgICAgICAgLnBpcGUoc3RhcnRXaXRoKHRoaXMubGlzdE9mTnpUaERpcmVjdGl2ZSksIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSlcclxuICAgICAgICAuc3Vic2NyaWJlKHRoaXMubGlzdE9mQ29sdW1ucyQpO1xyXG4gICAgICAvKiogc2V0IGxhc3QgbGVmdCBhbmQgZmlyc3QgcmlnaHQgKiovXHJcbiAgICAgIHRoaXMubGlzdE9mRml4ZWRMZWZ0Q29sdW1uQ2hhbmdlcyQuc3Vic2NyaWJlKGxpc3RPZkZpeGVkTGVmdCA9PiB7XHJcbiAgICAgICAgbGlzdE9mRml4ZWRMZWZ0LmZvckVhY2goY2VsbCA9PiBjZWxsLnNldElzTGFzdExlZnQoY2VsbCA9PT0gbGlzdE9mRml4ZWRMZWZ0W2xpc3RPZkZpeGVkTGVmdC5sZW5ndGggLSAxXSkpO1xyXG4gICAgICB9KTtcclxuICAgICAgdGhpcy5saXN0T2ZGaXhlZFJpZ2h0Q29sdW1uQ2hhbmdlcyQuc3Vic2NyaWJlKGxpc3RPZkZpeGVkUmlnaHQgPT4ge1xyXG4gICAgICAgIGxpc3RPZkZpeGVkUmlnaHQuZm9yRWFjaChjZWxsID0+IGNlbGwuc2V0SXNGaXJzdFJpZ2h0KGNlbGwgPT09IGxpc3RPZkZpeGVkUmlnaHRbMF0pKTtcclxuICAgICAgfSk7XHJcbiAgICAgIC8qKiBjYWxjdWxhdGUgZml4ZWQgdGRzTGVmdCBhbmQgdGRzUmlnaHQgKiovXHJcbiAgICAgIGNvbWJpbmVMYXRlc3QoW3RoaXMudGRzVGFibGVTdHlsZVNlcnZpY2UubGlzdE9mTGlzdE9mVGhXaWR0aCQsIHRoaXMubGlzdE9mRml4ZWRMZWZ0Q29sdW1uQ2hhbmdlcyRdKVxyXG4gICAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSlcclxuICAgICAgICAuc3Vic2NyaWJlKChbbGlzdE9mQXV0b1dpZHRoLCBsaXN0T2ZMZWZ0Q2VsbF0pID0+IHtcclxuICAgICAgICAgIGxpc3RPZkxlZnRDZWxsLmZvckVhY2goKGNlbGwsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChjZWxsLmlzQXV0b0xlZnQpIHtcclxuICAgICAgICAgICAgICBjb25zdCBjdXJyZW50QXJyYXkgPSBsaXN0T2ZMZWZ0Q2VsbC5zbGljZSgwLCBpbmRleCk7XHJcbiAgICAgICAgICAgICAgY29uc3QgY291bnQgPSBjdXJyZW50QXJyYXkucmVkdWNlKChwcmUsIGN1cikgPT4gcHJlICsgKGN1ci5jb2xzcGFuIHx8IGN1ci5jb2xTcGFuIHx8IDEpLCAwKTtcclxuICAgICAgICAgICAgICBjb25zdCB3aWR0aCA9IGxpc3RPZkF1dG9XaWR0aC5zbGljZSgwLCBjb3VudCkucmVkdWNlKChwcmUsIGN1cikgPT4gcHJlICsgY3VyLCAwKTtcclxuICAgICAgICAgICAgICBjZWxsLnNldEF1dG9MZWZ0V2lkdGgoYCR7d2lkdGh9cHhgKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIGNvbWJpbmVMYXRlc3QoW3RoaXMudGRzVGFibGVTdHlsZVNlcnZpY2UubGlzdE9mTGlzdE9mVGhXaWR0aCQsIHRoaXMubGlzdE9mRml4ZWRSaWdodENvbHVtbkNoYW5nZXMkXSlcclxuICAgICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95JCkpXHJcbiAgICAgICAgLnN1YnNjcmliZSgoW2xpc3RPZkF1dG9XaWR0aCwgbGlzdE9mUmlnaHRDZWxsXSkgPT4ge1xyXG4gICAgICAgICAgbGlzdE9mUmlnaHRDZWxsLmZvckVhY2goKF8sIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNlbGwgPSBsaXN0T2ZSaWdodENlbGxbbGlzdE9mUmlnaHRDZWxsLmxlbmd0aCAtIGluZGV4IC0gMV07XHJcbiAgICAgICAgICAgIGlmIChjZWxsLmlzQXV0b1JpZ2h0KSB7XHJcbiAgICAgICAgICAgICAgY29uc3QgY3VycmVudEFycmF5ID0gbGlzdE9mUmlnaHRDZWxsLnNsaWNlKGxpc3RPZlJpZ2h0Q2VsbC5sZW5ndGggLSBpbmRleCwgbGlzdE9mUmlnaHRDZWxsLmxlbmd0aCk7XHJcbiAgICAgICAgICAgICAgY29uc3QgY291bnQgPSBjdXJyZW50QXJyYXkucmVkdWNlKChwcmUsIGN1cikgPT4gcHJlICsgKGN1ci5jb2xzcGFuIHx8IGN1ci5jb2xTcGFuIHx8IDEpLCAwKTtcclxuICAgICAgICAgICAgICBjb25zdCB3aWR0aCA9IGxpc3RPZkF1dG9XaWR0aFxyXG4gICAgICAgICAgICAgICAgLnNsaWNlKGxpc3RPZkF1dG9XaWR0aC5sZW5ndGggLSBjb3VudCwgbGlzdE9mQXV0b1dpZHRoLmxlbmd0aClcclxuICAgICAgICAgICAgICAgIC5yZWR1Y2UoKHByZSwgY3VyKSA9PiBwcmUgKyBjdXIsIDApO1xyXG4gICAgICAgICAgICAgIGNlbGwuc2V0QXV0b1JpZ2h0V2lkdGgoYCR7d2lkdGh9cHhgKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZGVzdHJveSQubmV4dCgpO1xyXG4gICAgdGhpcy5kZXN0cm95JC5jb21wbGV0ZSgpO1xyXG4gIH1cclxufVxyXG4iXX0=