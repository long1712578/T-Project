import { __decorate } from "tslib";
import { DOCUMENT } from '@angular/common';
import { Directive, Inject, Input, Optional } from '@angular/core';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { WithConfig } from 'tds-ui/core/config';
import { InputBoolean } from 'tds-ui/shared/utility';
import * as i0 from "@angular/core";
import * as i1 from "tds-ui/core/config";
import * as i2 from "./image.service";
import * as i3 from "./image-group.component";
import * as i4 from "@angular/cdk/bidi";
const TDS_CONFIG_MODULE_NAME = 'image';
export class TDSImageDirective {
    constructor(document, tdsConfigService, elementRef, tdsImageService, cdr, parentGroup, directionality) {
        this.document = document;
        this.tdsConfigService = tdsConfigService;
        this.elementRef = elementRef;
        this.tdsImageService = tdsImageService;
        this.cdr = cdr;
        this.parentGroup = parentGroup;
        this.directionality = directionality;
        this._TDSModuleName = TDS_CONFIG_MODULE_NAME;
        this.tdsSrc = '';
        this.srcset = '';
        this.disablePreview = false;
        this.fallback = null;
        this.placeholder = null;
        this.status = 'normal';
        this.destroy$ = new Subject();
    }
    get previewable() {
        return !this.disablePreview && this.status !== 'error';
    }
    ngOnInit() {
        this.backLoad();
        if (this.parentGroup) {
            this.parentGroup.addImage(this);
        }
        if (this.directionality) {
            this.directionality.change?.pipe(takeUntil(this.destroy$)).subscribe((direction) => {
                this.dir = direction;
                this.cdr.detectChanges();
            });
            this.dir = this.directionality.value;
        }
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroy$.complete();
    }
    onPreview() {
        if (!this.previewable) {
            return;
        }
        if (this.parentGroup) {
            // preview inside image group
            const previewAbleImages = this.parentGroup.images.filter(e => e.previewable);
            const previewImages = previewAbleImages.map(e => ({ src: e.tdsSrc, srcset: e.srcset }));
            const previewIndex = previewAbleImages.findIndex(el => this === el);
            const previewRef = this.tdsImageService.preview(previewImages, { direction: this.dir });
            previewRef.switchTo(previewIndex);
        }
        else {
            // preview not inside image group
            const previewImages = [{ src: this.tdsSrc, srcset: this.srcset }];
            this.tdsImageService.preview(previewImages, { direction: this.dir });
        }
    }
    getElement() {
        return this.elementRef;
    }
    ngOnChanges(changes) {
        const { tdsSrc } = changes;
        if (tdsSrc) {
            this.getElement().nativeElement.src = tdsSrc.currentValue;
            this.backLoad();
        }
    }
    /**
     * use internal Image object handle fallback & placeholder
     *
     * @private
     */
    backLoad() {
        this.backLoadImage = this.document.createElement('img');
        this.backLoadImage.src = this.tdsSrc;
        this.backLoadImage.srcset = this.srcset;
        this.status = 'loading';
        if (this.backLoadImage.complete) {
            this.status = 'normal';
            this.getElement().nativeElement.src = this.tdsSrc;
            this.getElement().nativeElement.srcset = this.srcset;
        }
        else {
            if (this.placeholder) {
                this.getElement().nativeElement.src = this.placeholder;
                this.getElement().nativeElement.srcset = '';
            }
            else {
                this.getElement().nativeElement.src = this.tdsSrc;
                this.getElement().nativeElement.srcset = this.srcset;
            }
            this.backLoadImage.onload = () => {
                this.status = 'normal';
                this.getElement().nativeElement.src = this.tdsSrc;
                this.getElement().nativeElement.srcset = this.srcset;
            };
            this.backLoadImage.onerror = () => {
                this.status = 'error';
                if (this.fallback) {
                    this.getElement().nativeElement.src = this.fallback;
                    this.getElement().nativeElement.srcset = '';
                }
            };
        }
    }
}
TDSImageDirective.ɵfac = function TDSImageDirective_Factory(t) { return new (t || TDSImageDirective)(i0.ɵɵdirectiveInject(DOCUMENT), i0.ɵɵdirectiveInject(i1.TDSConfigService), i0.ɵɵdirectiveInject(i0.ElementRef), i0.ɵɵdirectiveInject(i2.TDSImageService), i0.ɵɵdirectiveInject(i0.ChangeDetectorRef), i0.ɵɵdirectiveInject(i3.TDSImageGroupComponent, 8), i0.ɵɵdirectiveInject(i4.Directionality, 8)); };
TDSImageDirective.ɵdir = /*@__PURE__*/ i0.ɵɵdefineDirective({ type: TDSImageDirective, selectors: [["img", "tds-image", ""]], hostBindings: function TDSImageDirective_HostBindings(rf, ctx) { if (rf & 1) {
        i0.ɵɵlistener("click", function TDSImageDirective_click_HostBindingHandler() { return ctx.onPreview(); });
    } }, inputs: { tdsSrc: "tdsSrc", srcset: "srcset", disablePreview: "disablePreview", fallback: "fallback", placeholder: "placeholder" }, exportAs: ["tdsImage"], features: [i0.ɵɵNgOnChangesFeature] });
__decorate([
    InputBoolean(),
    WithConfig()
], TDSImageDirective.prototype, "disablePreview", void 0);
__decorate([
    WithConfig()
], TDSImageDirective.prototype, "fallback", void 0);
__decorate([
    WithConfig()
], TDSImageDirective.prototype, "placeholder", void 0);
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(TDSImageDirective, [{
        type: Directive,
        args: [{
                selector: 'img[tds-image]',
                exportAs: 'tdsImage',
                host: {
                    '(click)': 'onPreview()'
                }
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [DOCUMENT]
            }] }, { type: i1.TDSConfigService }, { type: i0.ElementRef }, { type: i2.TDSImageService }, { type: i0.ChangeDetectorRef }, { type: i3.TDSImageGroupComponent, decorators: [{
                type: Optional
            }] }, { type: i4.Directionality, decorators: [{
                type: Optional
            }] }]; }, { tdsSrc: [{
            type: Input
        }], srcset: [{
            type: Input
        }], disablePreview: [{
            type: Input
        }], fallback: [{
            type: Input
        }], placeholder: [{
            type: Input
        }] }); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2UuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvdGRzLXVpL2ltYWdlL2ltYWdlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBSUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFFTCxTQUFTLEVBRVQsTUFBTSxFQUNOLEtBQUssRUFJTCxRQUFRLEVBRVQsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFrQyxVQUFVLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNoRixPQUFPLEVBQUUsWUFBWSxFQUFjLE1BQU0sdUJBQXVCLENBQUM7Ozs7OztBQU1qRSxNQUFNLHNCQUFzQixHQUFpQixPQUFPLENBQUM7QUFXckQsTUFBTSxPQUFPLGlCQUFpQjtJQW9CNUIsWUFDNEIsUUFBb0IsRUFDdkMsZ0JBQWtDLEVBQ2pDLFVBQXNCLEVBQ3RCLGVBQWdDLEVBQzlCLEdBQXNCLEVBQ1osV0FBbUMsRUFDbkMsY0FBOEI7UUFOeEIsYUFBUSxHQUFSLFFBQVEsQ0FBWTtRQUN2QyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2pDLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDdEIsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQzlCLFFBQUcsR0FBSCxHQUFHLENBQW1CO1FBQ1osZ0JBQVcsR0FBWCxXQUFXLENBQXdCO1FBQ25DLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQTFCM0MsbUJBQWMsR0FBaUIsc0JBQXNCLENBQUM7UUFJdEQsV0FBTSxHQUFHLEVBQUUsQ0FBQztRQUNaLFdBQU0sR0FBRyxFQUFFLENBQUM7UUFDa0IsbUJBQWMsR0FBWSxLQUFLLENBQUM7UUFDaEQsYUFBUSxH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c291cmNlc0NvbnRlbnQiOlsiXHJcblxyXG5pbXBvcnQgeyBEaXJlY3Rpb24sIERpcmVjdGlvbmFsaXR5IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2JpZGknO1xyXG5pbXBvcnQgeyBCb29sZWFuSW5wdXQgfSBmcm9tICdAYW5ndWxhci9jZGsvY29lcmNpb24nO1xyXG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcbmltcG9ydCB7XHJcbiAgQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgRGlyZWN0aXZlLFxyXG4gIEVsZW1lbnRSZWYsXHJcbiAgSW5qZWN0LFxyXG4gIElucHV0LFxyXG4gIE9uQ2hhbmdlcyxcclxuICBPbkRlc3Ryb3ksXHJcbiAgT25Jbml0LFxyXG4gIE9wdGlvbmFsLFxyXG4gIFNpbXBsZUNoYW5nZXNcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IFREU0NvbmZpZ0tleSwgVERTQ29uZmlnU2VydmljZSwgV2l0aENvbmZpZyB9IGZyb20gJ3Rkcy11aS9jb3JlL2NvbmZpZyc7XHJcbmltcG9ydCB7IElucHV0Qm9vbGVhbiwgVERTU2FmZUFueSB9IGZyb20gJ3Rkcy11aS9zaGFyZWQvdXRpbGl0eSc7XHJcblxyXG5cclxuaW1wb3J0IHsgVERTSW1hZ2VHcm91cENvbXBvbmVudCB9IGZyb20gJy4vaW1hZ2UtZ3JvdXAuY29tcG9uZW50JztcclxuaW1wb3J0IHsgVERTSW1hZ2VTZXJ2aWNlIH0gZnJvbSAnLi9pbWFnZS5zZXJ2aWNlJztcclxuXHJcbmNvbnN0IFREU19DT05GSUdfTU9EVUxFX05BTUU6IFREU0NvbmZpZ0tleSA9ICdpbWFnZSc7XHJcblxyXG5leHBvcnQgdHlwZSBJbWFnZVN0YXR1c1R5cGUgPSAnZXJyb3InIHwgJ2xvYWRpbmcnIHwgJ25vcm1hbCc7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ2ltZ1t0ZHMtaW1hZ2VdJyxcclxuICBleHBvcnRBczogJ3Rkc0ltYWdlJyxcclxuICBob3N0OiB7XHJcbiAgICAnKGNsaWNrKSc6ICdvblByZXZpZXcoKSdcclxuICB9XHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBURFNJbWFnZURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xyXG4gIHJlYWRvbmx5IF9URFNNb2R1bGVOYW1lOiBURFNDb25maWdLZXkgPSBURFNfQ09ORklHX01PRFVMRV9OQU1FO1xyXG5cclxuICBzdGF0aWMgbmdBY2NlcHRJbnB1dFR5cGVfZGlzYWJsZVByZXZpZXc6IEJvb2xlYW5JbnB1dDtcclxuXHJcbiAgQElucHV0KCkgdGRzU3JjID0gJyc7XHJcbiAgQElucHV0KCkgc3Jjc2V0ID0gJyc7XHJcbiAgQElucHV0KCkgQElucHV0Qm9vbGVhbigpIEBXaXRoQ29uZmlnKCkgZGlzYWJsZVByZXZpZXc6IGJvb2xlYW4gPSBmYWxzZTtcclxuICBASW5wdXQoKSBAV2l0aENvbmZpZygpIGZhbGxiYWNrOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcclxuICBASW5wdXQoKSBAV2l0aENvbmZpZygpIHBsYWNlaG9sZGVyOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcclxuXHJcbiAgZGlyPzogRGlyZWN0aW9uO1xyXG4gIGJhY2tMb2FkSW1hZ2UhOiBIVE1MSW1hZ2VFbGVtZW50O1xyXG4gIHByaXZhdGUgc3RhdHVzOiBJbWFnZVN0YXR1c1R5cGUgPSAnbm9ybWFsJztcclxuICBwcml2YXRlIGRlc3Ryb3kkOiBTdWJqZWN0PHZvaWQ+ID0gbmV3IFN1YmplY3QoKTtcclxuXHJcbiAgZ2V0IHByZXZpZXdhYmxlKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuICF0aGlzLmRpc2FibGVQcmV2aWV3ICYmIHRoaXMuc3RhdHVzICE9PSAnZXJyb3InO1xyXG4gIH1cclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBASW5qZWN0KERPQ1VNRU5UKSBwcml2YXRlIGRvY3VtZW50OiBURFNTYWZlQW55LFxyXG4gICAgcHVibGljIHRkc0NvbmZpZ1NlcnZpY2U6IFREU0NvbmZpZ1NlcnZpY2UsXHJcbiAgICBwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsXHJcbiAgICBwcml2YXRlIHRkc0ltYWdlU2VydmljZTogVERTSW1hZ2VTZXJ2aWNlLFxyXG4gICAgcHJvdGVjdGVkIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHBhcmVudEdyb3VwOiBURFNJbWFnZUdyb3VwQ29tcG9uZW50LFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBkaXJlY3Rpb25hbGl0eTogRGlyZWN0aW9uYWxpdHlcclxuICApIHt9XHJcblxyXG4gIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgdGhpcy5iYWNrTG9hZCgpO1xyXG4gICAgaWYgKHRoaXMucGFyZW50R3JvdXApIHtcclxuICAgICAgdGhpcy5wYXJlbnRHcm91cC5hZGRJbWFnZSh0aGlzKTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmRpcmVjdGlvbmFsaXR5KSB7XHJcbiAgICAgIHRoaXMuZGlyZWN0aW9uYWxpdHkuY2hhbmdlPy5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSkuc3Vic2NyaWJlKChkaXJlY3Rpb246IERpcmVjdGlvbikgPT4ge1xyXG4gICAgICAgIHRoaXMuZGlyID0gZGlyZWN0aW9uO1xyXG4gICAgICAgIHRoaXMuY2RyLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgfSk7XHJcbiAgICAgIHRoaXMuZGlyID0gdGhpcy5kaXJlY3Rpb25hbGl0eS52YWx1ZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgdGhpcy5kZXN0cm95JC5uZXh0KCk7XHJcbiAgICB0aGlzLmRlc3Ryb3kkLmNvbXBsZXRlKCk7XHJcbiAgfVxyXG5cclxuICBvblByZXZpZXcoKTogdm9pZCB7XHJcbiAgICBpZiAoIXRoaXMucHJldmlld2FibGUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLnBhcmVudEdyb3VwKSB7XHJcbiAgICAgIC8vIHByZXZpZXcgaW5zaWRlIGltYWdlIGdyb3VwXHJcbiAgICAgIGNvbnN0IHByZXZpZXdBYmxlSW1hZ2VzID0gdGhpcy5wYXJlbnRHcm91cC5pbWFnZXMuZmlsdGVyKGUgPT4gZS5wcmV2aWV3YWJsZSk7XHJcbiAgICAgIGNvbnN0IHByZXZpZXdJbWFnZXMgPSBwcmV2aWV3QWJsZUltYWdlcy5tYXAoZSA9PiAoeyBzcmM6IGUudGRzU3JjLCBzcmNzZXQ6IGUuc3Jjc2V0IH0pKTtcclxuICAgICAgY29uc3QgcHJldmlld0luZGV4ID0gcHJldmlld0FibGVJbWFnZXMuZmluZEluZGV4KGVsID0+IHRoaXMgPT09IGVsKTtcclxuICAgICAgY29uc3QgcHJldmlld1JlZiA9IHRoaXMudGRzSW1hZ2VTZXJ2aWNlLnByZXZpZXcocHJldmlld0ltYWdlcywgeyBkaXJlY3Rpb246IHRoaXMuZGlyIH0pO1xyXG4gICAgICBwcmV2aWV3UmVmLnN3aXRjaFRvKHByZXZpZXdJbmRleCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyBwcmV2aWV3IG5vdCBpbnNpZGUgaW1hZ2UgZ3JvdXBcclxuICAgICAgY29uc3QgcHJldmlld0ltYWdlcyA9IFt7IHNyYzogdGhpcy50ZHNTcmMsIHNyY3NldDogdGhpcy5zcmNzZXQgfV07XHJcbiAgICAgIHRoaXMudGRzSW1hZ2VTZXJ2aWNlLnByZXZpZXcocHJldmlld0ltYWdlcywgeyBkaXJlY3Rpb246IHRoaXMuZGlyIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0RWxlbWVudCgpOiBFbGVtZW50UmVmPEhUTUxJbWFnZUVsZW1lbnQ+IHtcclxuICAgIHJldHVybiB0aGlzLmVsZW1lbnRSZWY7XHJcbiAgfVxyXG5cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XHJcbiAgICBjb25zdCB7IHRkc1NyYyB9ID0gY2hhbmdlcztcclxuICAgIGlmICh0ZHNTcmMpIHtcclxuICAgICAgdGhpcy5nZXRFbGVtZW50KCkubmF0aXZlRWxlbWVudC5zcmMgPSB0ZHNTcmMuY3VycmVudFZhbHVlO1xyXG4gICAgICB0aGlzLmJhY2tMb2FkKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiB1c2UgaW50ZXJuYWwgSW1hZ2Ugb2JqZWN0IGhhbmRsZSBmYWxsYmFjayAmIHBsYWNlaG9sZGVyXHJcbiAgICpcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIHByaXZhdGUgYmFja0xvYWQoKTogdm9pZCB7XHJcbiAgICB0aGlzLmJhY2tMb2FkSW1hZ2UgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpO1xyXG4gICAgdGhpcy5iYWNrTG9hZEltYWdlLnNyYyA9IHRoaXMudGRzU3JjO1xyXG4gICAgdGhpcy5iYWNrTG9hZEltYWdlLnNyY3NldCA9IHRoaXMuc3Jjc2V0O1xyXG4gICAgdGhpcy5zdGF0dXMgPSAnbG9hZGluZyc7XHJcblxyXG4gICAgaWYgKHRoaXMuYmFja0xvYWRJbWFnZS5jb21wbGV0ZSkge1xyXG4gICAgICB0aGlzLnN0YXR1cyA9ICdub3JtYWwnO1xyXG4gICAgICB0aGlzLmdldEVsZW1lbnQoKS5uYXRpdmVFbGVtZW50LnNyYyA9IHRoaXMudGRzU3JjO1xyXG4gICAgICB0aGlzLmdldEVsZW1lbnQoKS5uYXRpdmVFbGVtZW50LnNyY3NldCA9IHRoaXMuc3Jjc2V0O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaWYgKHRoaXMucGxhY2Vob2xkZXIpIHtcclxuICAgICAgICB0aGlzLmdldEVsZW1lbnQoKS5uYXRpdmVFbGVtZW50LnNyYyA9IHRoaXMucGxhY2Vob2xkZXI7XHJcbiAgICAgICAgdGhpcy5nZXRFbGVtZW50KCkubmF0aXZlRWxlbWVudC5zcmNzZXQgPSAnJztcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLmdldEVsZW1lbnQoKS5uYXRpdmVFbGVtZW50LnNyYyA9IHRoaXMudGRzU3JjO1xyXG4gICAgICAgIHRoaXMuZ2V0RWxlbWVudCgpLm5hdGl2ZUVsZW1lbnQuc3Jjc2V0ID0gdGhpcy5zcmNzZXQ7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMuYmFja0xvYWRJbWFnZS5vbmxvYWQgPSAoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5zdGF0dXMgPSAnbm9ybWFsJztcclxuICAgICAgICB0aGlzLmdldEVsZW1lbnQoKS5uYXRpdmVFbGVtZW50LnNyYyA9IHRoaXMudGRzU3JjO1xyXG4gICAgICAgIHRoaXMuZ2V0RWxlbWVudCgpLm5hdGl2ZUVsZW1lbnQuc3Jjc2V0ID0gdGhpcy5zcmNzZXQ7XHJcbiAgICAgIH07XHJcblxyXG4gICAgICB0aGlzLmJhY2tMb2FkSW1hZ2Uub25lcnJvciA9ICgpID0+IHtcclxuICAgICAgICB0aGlzLnN0YXR1cyA9ICdlcnJvcic7XHJcbiAgICAgICAgaWYgKHRoaXMuZmFsbGJhY2spIHtcclxuICAgICAgICAgIHRoaXMuZ2V0RWxlbWVudCgpLm5hdGl2ZUVsZW1lbnQuc3JjID0gdGhpcy5mYWxsYmFjaztcclxuICAgICAgICAgIHRoaXMuZ2V0RWxlbWVudCgpLm5hdGl2ZUVsZW1lbnQuc3Jjc2V0ID0gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=