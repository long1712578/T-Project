// from https://github.com/hsuanxyz/ng-time-parser
import { FormStyle, getLocaleDayPeriods, TranslationWidth } from '@angular/common';
import { TDSHelperObject } from 'tds-ui/shared/utility';
export class NgTimeParser {
    constructor(format, localeId) {
        this.format = format;
        this.localeId = localeId;
        this.regex = null;
        this.matchMap = {
            hour: null,
            minute: null,
            second: null,
            periodNarrow: null,
            periodWide: null,
            periodAbbreviated: null
        };
        this.genRegexp();
    }
    toDate(str) {
        const result = this.getTimeResult(str);
        const time = new Date();
        if (TDSHelperObject.hasValue(result?.hour)) {
            time.setHours(result.hour);
        }
        if (TDSHelperObject.hasValue(result?.minute)) {
            time.setMinutes(result.minute);
        }
        if (TDSHelperObject.hasValue(result?.second)) {
            time.setSeconds(result.second);
        }
        if (result?.period === 1 && time.getHours() < 12) {
            time.setHours(time.getHours() + 12);
        }
        return time;
    }
    getTimeResult(str) {
        const match = this.regex.exec(str);
        let period = null;
        if (match) {
            if (TDSHelperObject.hasValue(this.matchMap.periodNarrow)) {
                period = getLocaleDayPeriods(this.localeId, FormStyle.Format, TranslationWidth.Narrow).indexOf(match[this.matchMap.periodNarrow + 1]);
            }
            if (TDSHelperObject.hasValue(this.matchMap.periodWide)) {
                period = getLocaleDayPeriods(this.localeId, FormStyle.Format, TranslationWidth.Wide).indexOf(match[this.matchMap.periodWide + 1]);
            }
            if (TDSHelperObject.hasValue(this.matchMap.periodAbbreviated)) {
                period = getLocaleDayPeriods(this.localeId, FormStyle.Format, TranslationWidth.Abbreviated).indexOf(match[this.matchMap.periodAbbreviated + 1]);
            }
            return {
                hour: TDSHelperObject.hasValue(this.matchMap.hour) ? Number.parseInt(match[this.matchMap.hour + 1], 10) : null,
                minute: TDSHelperObject.hasValue(this.matchMap.minute) ? Number.parseInt(match[this.matchMap.minute + 1], 10) : null,
                second: TDSHelperObject.hasValue(this.matchMap.second) ? Number.parseInt(match[this.matchMap.second + 1], 10) : null,
                period
            };
        }
        else {
            return null;
        }
    }
    genRegexp() {
        let regexStr = this.format.replace(/([.*+?^=!:${}()|[\]\/\\])/g, '\\$&');
        const hourRegex = /h{1,2}/i;
        const minuteRegex = /m{1,2}/;
        const secondRegex = /s{1,2}/;
        const periodNarrow = /aaaaa/;
        const periodWide = /aaaa/;
        const periodAbbreviated = /a{1,3}/;
        const hourMatch = hourRegex.exec(this.format);
        const minuteMatch = minuteRegex.exec(this.format);
        const secondMatch = secondRegex.exec(this.format);
        const periodNarrowMatch = periodNarrow.exec(this.format);
        let periodWideMatch = null;
        let periodAbbreviatedMatch = null;
        if (!periodNarrowMatch) {
            periodWideMatch = periodWide.exec(this.format);
        }
        if (!periodWideMatch && !periodNarrowMatch) {
            periodAbbreviatedMatch = periodAbbreviated.exec(this.format);
        }
        const matchs = [hourMatch, minuteMatch, secondMatch, periodNarrowMatch, periodWideMatch, periodAbbreviatedMatch]
            .filter(m => !!m)
            .sort((a, b) => a.index - b.index);
        matchs.forEach((match, index) => {
            switch (match) {
                case hourMatch:
                    this.matchMap.hour = index;
                    regexStr = regexStr.replace(hourRegex, '(\\d{1,2})');
                    break;
                case minuteMatch:
                    this.matchMap.minute = index;
                    regexStr = regexStr.replace(minuteRegex, '(\\d{1,2})');
                    break;
                case secondMatch:
                    this.matchMap.second = index;
                    regexStr = regexStr.replace(secondRegex, '(\\d{1,2})');
                    break;
                case periodNarrowMatch:
                    this.matchMap.periodNarrow = index;
                    const periodsNarrow = getLocaleDayPeriods(this.localeId, FormStyle.Format, TranslationWidth.Narrow).join('|');
                    regexStr = regexStr.replace(periodNarrow, `(${periodsNarrow})`);
                    break;
                case periodWideMatch:
                    this.matchMap.periodWide = index;
                    const periodsWide = getLocaleDayPeriods(this.localeId, FormStyle.Format, TranslationWidth.Wide).join('|');
                    regexStr = regexStr.replace(periodWide, `(${periodsWide})`);
                    break;
                case periodAbbreviatedMatch:
                    this.matchMap.periodAbbreviated = index;
                    const periodsAbbreviated = getLocaleDayPeriods(this.localeId, FormStyle.Format, TranslationWidth.Abbreviated).join('|');
                    regexStr = regexStr.replace(periodAbbreviated, `(${periodsAbbreviated})`);
                    break;
            }
        });
        this.regex = new RegExp(regexStr);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZS1wYXJzZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy90ZHMtdWkvY29yZS90aW1lL3RpbWUtcGFyc2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLGtEQUFrRDtBQUNsRCxPQUFPLEVBQUUsU0FBUyxFQUFFLG1CQUFtQixFQUFFLGdCQUFnQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDbkYsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBU3hELE1BQU0sT0FBTyxZQUFZO0lBV3ZCLFlBQW9CLE1BQWMsRUFBVSxRQUFnQjtRQUF4QyxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBUTtRQVY1RCxVQUFLLEdBQVcsSUFBSyxDQUFDO1FBQ3RCLGFBQVEsR0FBcUM7WUFDM0MsSUFBSSxFQUFFLElBQUk7WUFDVixNQUFNLEVBQUUsSUFBSTtZQUNaLE1BQU0sRUFBRSxJQUFJO1lBQ1osWUFBWSxFQUFFLElBQUk7WUFDbEIsVUFBVSxFQUFFLElBQUk7WUFDaEIsaUJBQWlCLEVBQUUsSUFBSTtTQUN4QixDQUFDO1FBR0EsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQ25CLENBQUM7SUFFRCxNQUFNLENBQUMsR0FBVztRQUNoQixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZDLE1BQU0sSUFBSSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFFeEIsSUFBSSxlQUFlLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRTtZQUMxQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU8sQ0FBQyxJQUFjLENBQUMsQ0FBQztTQUN2QztRQUVELElBQUksZUFBZSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLEVBQUU7WUFDNUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxN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YSxHQUFHLENBQUMsQ0FBQztvQkFDaEUsTUFBTTtnQkFDUixLQUFLLGVBQWU7b0JBQ2xCLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQztvQkFDakMsTUFBTSxXQUFXLEdBQUcsbUJBQW1CLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUMsTUFBTSxFQUFFLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDMUcsUUFBUSxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLElBQUksV0FBVyxHQUFHLENBQUMsQ0FBQztvQkFDNUQsTUFBTTtnQkFDUixLQUFLLHNCQUFzQjtvQkFDekIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsR0FBRyxLQUFLLENBQUM7b0JBQ3hDLE1BQU0sa0JBQWtCLEdBQUcsbUJBQW1CLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUMsTUFBTSxFQUFFLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDeEgsUUFBUSxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsSUFBSSxrQkFBa0IsR0FBRyxDQUFDLENBQUM7b0JBQzFFLE1BQU07YUFDVDtRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNwQyxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuXHJcbi8vIGZyb20gaHR0cHM6Ly9naXRodWIuY29tL2hzdWFueHl6L25nLXRpbWUtcGFyc2VyXHJcbmltcG9ydCB7IEZvcm1TdHlsZSwgZ2V0TG9jYWxlRGF5UGVyaW9kcywgVHJhbnNsYXRpb25XaWR0aCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcbmltcG9ydCB7IFREU0hlbHBlck9iamVjdCB9IGZyb20gJ3Rkcy11aS9zaGFyZWQvdXRpbGl0eSc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFRpbWVSZXN1bHQge1xyXG4gIGhvdXI6IG51bWJlciB8IG51bGw7XHJcbiAgbWludXRlOiBudW1iZXIgfCBudWxsO1xyXG4gIHNlY29uZDogbnVtYmVyIHwgbnVsbDtcclxuICBwZXJpb2Q6IG51bWJlciB8IG51bGw7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBOZ1RpbWVQYXJzZXIge1xyXG4gIHJlZ2V4OiBSZWdFeHAgPSBudWxsITtcclxuICBtYXRjaE1hcDogeyBba2V5OiBzdHJpbmddOiBudWxsIHwgbnVtYmVyIH0gPSB7XHJcbiAgICBob3VyOiBudWxsLFxyXG4gICAgbWludXRlOiBudWxsLFxyXG4gICAgc2Vjb25kOiBudWxsLFxyXG4gICAgcGVyaW9kTmFycm93OiBudWxsLFxyXG4gICAgcGVyaW9kV2lkZTogbnVsbCxcclxuICAgIHBlcmlvZEFiYnJldmlhdGVkOiBudWxsXHJcbiAgfTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBmb3JtYXQ6IHN0cmluZywgcHJpdmF0ZSBsb2NhbGVJZDogc3RyaW5nKSB7XHJcbiAgICB0aGlzLmdlblJlZ2V4cCgpO1xyXG4gIH1cclxuXHJcbiAgdG9EYXRlKHN0cjogc3RyaW5nKTogRGF0ZSB7XHJcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmdldFRpbWVSZXN1bHQoc3RyKTtcclxuICAgIGNvbnN0IHRpbWUgPSBuZXcgRGF0ZSgpO1xyXG5cclxuICAgIGlmIChURFNIZWxwZXJPYmplY3QuaGFzVmFsdWUocmVzdWx0Py5ob3VyKSkge1xyXG4gICAgICB0aW1lLnNldEhvdXJzKHJlc3VsdCEuaG91ciBhcyBudW1iZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChURFNIZWxwZXJPYmplY3QuaGFzVmFsdWUocmVzdWx0Py5taW51dGUpKSB7XHJcbiAgICAgIHRpbWUuc2V0TWludXRlcyhyZXN1bHQhLm1pbnV0ZSBhcyBudW1iZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChURFNIZWxwZXJPYmplY3QuaGFzVmFsdWUocmVzdWx0Py5zZWNvbmQpKSB7XHJcbiAgICAgIHRpbWUuc2V0U2Vjb25kcyhyZXN1bHQhLnNlY29uZCBhcyBudW1iZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChyZXN1bHQ/LnBlcmlvZCA9PT0gMSAmJiB0aW1lLmdldEhvdXJzKCkgPCAxMikge1xyXG4gICAgICB0aW1lLnNldEhvdXJzKHRpbWUuZ2V0SG91cnMoKSArIDEyKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdGltZTtcclxuICB9XHJcblxyXG4gIGdldFRpbWVSZXN1bHQoc3RyOiBzdHJpbmcpOiBUaW1lUmVzdWx0IHwgbnVsbCB7XHJcbiAgICBjb25zdCBtYXRjaCA9IHRoaXMucmVnZXguZXhlYyhzdHIpO1xyXG4gICAgbGV0IHBlcmlvZCA9IG51bGw7XHJcbiAgICBpZiAobWF0Y2gpIHtcclxuICAgICAgaWYgKFREU0hlbHBlck9iamVjdC5oYXNWYWx1ZSh0aGlzLm1hdGNoTWFwLnBlcmlvZE5hcnJvdykpIHtcclxuICAgICAgICBwZXJpb2QgPSBnZXRMb2NhbGVEYXlQZXJpb2RzKHRoaXMubG9jYWxlSWQsIEZvcm1TdHlsZS5Gb3JtYXQsIFRyYW5zbGF0aW9uV2lkdGguTmFycm93KS5pbmRleE9mKFxyXG4gICAgICAgICAgbWF0Y2hbdGhpcy5tYXRjaE1hcC5wZXJpb2ROYXJyb3chICsgMV1cclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChURFNIZWxwZXJPYmplY3QuaGFzVmFsdWUodGhpcy5tYXRjaE1hcC5wZXJpb2RXaWRlKSkge1xyXG4gICAgICAgIHBlcmlvZCA9IGdldExvY2FsZURheVBlcmlvZHModGhpcy5sb2NhbGVJZCwgRm9ybVN0eWxlLkZvcm1hdCwgVHJhbnNsYXRpb25XaWR0aC5XaWRlKS5pbmRleE9mKG1hdGNoW3RoaXMubWF0Y2hNYXAucGVyaW9kV2lkZSEgKyAxXSk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKFREU0hlbHBlck9iamVjdC5oYXNWYWx1ZSh0aGlzLm1hdGNoTWFwLnBlcmlvZEFiYnJldmlhdGVkKSkge1xyXG4gICAgICAgIHBlcmlvZCA9IGdldExvY2FsZURheVBlcmlvZHModGhpcy5sb2NhbGVJZCwgRm9ybVN0eWxlLkZvcm1hdCwgVHJhbnNsYXRpb25XaWR0aC5BYmJyZXZpYXRlZCkuaW5kZXhPZihcclxuICAgICAgICAgIG1hdGNoW3RoaXMubWF0Y2hNYXAucGVyaW9kQWJicmV2aWF0ZWQhICsgMV1cclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgaG91cjogVERTSGVscGVyT2JqZWN0Lmhhc1ZhbHVlKHRoaXMubWF0Y2hNYXAuaG91cikgPyBOdW1iZXIucGFyc2VJbnQobWF0Y2hbdGhpcy5tYXRjaE1hcC5ob3VyISArIDFdLCAxMCkgOiBudWxsLFxyXG4gICAgICAgIG1pbnV0ZTogVERTSGVscGVyT2JqZWN0Lmhhc1ZhbHVlKHRoaXMubWF0Y2hNYXAubWludXRlKSA/IE51bWJlci5wYXJzZUludChtYXRjaFt0aGlzLm1hdGNoTWFwLm1pbnV0ZSEgKyAxXSwgMTApIDogbnVsbCxcclxuICAgICAgICBzZWNvbmQ6IFREU0hlbHBlck9iamVjdC5oYXNWYWx1ZSh0aGlzLm1hdGNoTWFwLnNlY29uZCkgPyBOdW1iZXIucGFyc2VJbnQobWF0Y2hbdGhpcy5tYXRjaE1hcC5zZWNvbmQhICsgMV0sIDEwKSA6IG51bGwsXHJcbiAgICAgICAgcGVyaW9kXHJcbiAgICAgIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGdlblJlZ2V4cCgpOiB2b2lkIHtcclxuICAgIGxldCByZWdleFN0ciA9IHRoaXMuZm9ybWF0LnJlcGxhY2UoLyhbLiorP149IToke30oKXxbXFxdXFwvXFxcXF0pL2csICdcXFxcJCYnKTtcclxuICAgIGNvbnN0IGhvdXJSZWdleCA9IC9oezEsMn0vaTtcclxuICAgIGNvbnN0IG1pbnV0ZVJlZ2V4ID0gL217MSwyfS87XHJcbiAgICBjb25zdCBzZWNvbmRSZWdleCA9IC9zezEsMn0vO1xyXG4gICAgY29uc3QgcGVyaW9kTmFycm93ID0gL2FhYWFhLztcclxuICAgIGNvbnN0IHBlcmlvZFdpZGUgPSAvYWFhYS87XHJcbiAgICBjb25zdCBwZXJpb2RBYmJyZXZpYXRlZCA9IC9hezEsM30vO1xyXG5cclxuICAgIGNvbnN0IGhvdXJNYXRjaCA9IGhvdXJSZWdleC5leGVjKHRoaXMuZm9ybWF0KTtcclxuICAgIGNvbnN0IG1pbnV0ZU1hdGNoID0gbWludXRlUmVnZXguZXhlYyh0aGlzLmZvcm1hdCk7XHJcbiAgICBjb25zdCBzZWNvbmRNYXRjaCA9IHNlY29uZFJlZ2V4LmV4ZWModGhpcy5mb3JtYXQpO1xyXG4gICAgY29uc3QgcGVyaW9kTmFycm93TWF0Y2ggPSBwZXJpb2ROYXJyb3cuZXhlYyh0aGlzLmZvcm1hdCk7XHJcbiAgICBsZXQgcGVyaW9kV2lkZU1hdGNoOiBudWxsIHwgUmVnRXhwRXhlY0FycmF5ID0gbnVsbDtcclxuICAgIGxldCBwZXJpb2RBYmJyZXZpYXRlZE1hdGNoOiBudWxsIHwgUmVnRXhwRXhlY0FycmF5ID0gbnVsbDtcclxuICAgIGlmICghcGVyaW9kTmFycm93TWF0Y2gpIHtcclxuICAgICAgcGVyaW9kV2lkZU1hdGNoID0gcGVyaW9kV2lkZS5leGVjKHRoaXMuZm9ybWF0KTtcclxuICAgIH1cclxuICAgIGlmICghcGVyaW9kV2lkZU1hdGNoICYmICFwZXJpb2ROYXJyb3dNYXRjaCkge1xyXG4gICAgICBwZXJpb2RBYmJyZXZpYXRlZE1hdGNoID0gcGVyaW9kQWJicmV2aWF0ZWQuZXhlYyh0aGlzLmZvcm1hdCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbWF0Y2hzID0gW2hvdXJNYXRjaCwgbWludXRlTWF0Y2gsIHNlY29uZE1hdGNoLCBwZXJpb2ROYXJyb3dNYXRjaCwgcGVyaW9kV2lkZU1hdGNoLCBwZXJpb2RBYmJyZXZpYXRlZE1hdGNoXVxyXG4gICAgICAuZmlsdGVyKG0gPT4gISFtKVxyXG4gICAgICAuc29ydCgoYSwgYikgPT4gYSEuaW5kZXggLSBiIS5pbmRleCk7XHJcblxyXG4gICAgbWF0Y2hzLmZvckVhY2goKG1hdGNoLCBpbmRleCkgPT4ge1xyXG4gICAgICBzd2l0Y2ggKG1hdGNoKSB7XHJcbiAgICAgICAgY2FzZSBob3VyTWF0Y2g6XHJcbiAgICAgICAgICB0aGlzLm1hdGNoTWFwLmhvdXIgPSBpbmRleDtcclxuICAgICAgICAgIHJlZ2V4U3RyID0gcmVnZXhTdHIucmVwbGFjZShob3VyUmVnZXgsICcoXFxcXGR7MSwyfSknKTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgbWludXRlTWF0Y2g6XHJcbiAgICAgICAgICB0aGlzLm1hdGNoTWFwLm1pbnV0ZSA9IGluZGV4O1xyXG4gICAgICAgICAgcmVnZXhTdHIgPSByZWdleFN0ci5yZXBsYWNlKG1pbnV0ZVJlZ2V4LCAnKFxcXFxkezEsMn0pJyk7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlIHNlY29uZE1hdGNoOlxyXG4gICAgICAgICAgdGhpcy5tYXRjaE1hcC5zZWNvbmQgPSBpbmRleDtcclxuICAgICAgICAgIHJlZ2V4U3RyID0gcmVnZXhTdHIucmVwbGFjZShzZWNvbmRSZWdleCwgJyhcXFxcZHsxLDJ9KScpO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBwZXJpb2ROYXJyb3dNYXRjaDpcclxuICAgICAgICAgIHRoaXMubWF0Y2hNYXAucGVyaW9kTmFycm93ID0gaW5kZXg7XHJcbiAgICAgICAgICBjb25zdCBwZXJpb2RzTmFycm93ID0gZ2V0TG9jYWxlRGF5UGVyaW9kcyh0aGlzLmxvY2FsZUlkLCBGb3JtU3R5bGUuRm9ybWF0LCBUcmFuc2xhdGlvbldpZHRoLk5hcnJvdykuam9pbignfCcpO1xyXG4gICAgICAgICAgcmVnZXhTdHIgPSByZWdleFN0ci5yZXBsYWNlKHBlcmlvZE5hcnJvdywgYCgke3BlcmlvZHNOYXJyb3d9KWApO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBwZXJpb2RXaWRlTWF0Y2g6XHJcbiAgICAgICAgICB0aGlzLm1hdGNoTWFwLnBlcmlvZFdpZGUgPSBpbmRleDtcclxuICAgICAgICAgIGNvbnN0IHBlcmlvZHNXaWRlID0gZ2V0TG9jYWxlRGF5UGVyaW9kcyh0aGlzLmxvY2FsZUlkLCBGb3JtU3R5bGUuRm9ybWF0LCBUcmFuc2xhdGlvbldpZHRoLldpZGUpLmpvaW4oJ3wnKTtcclxuICAgICAgICAgIHJlZ2V4U3RyID0gcmVnZXhTdHIucmVwbGFjZShwZXJpb2RXaWRlLCBgKCR7cGVyaW9kc1dpZGV9KWApO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBwZXJpb2RBYmJyZXZpYXRlZE1hdGNoOlxyXG4gICAgICAgICAgdGhpcy5tYXRjaE1hcC5wZXJpb2RBYmJyZXZpYXRlZCA9IGluZGV4O1xyXG4gICAgICAgICAgY29uc3QgcGVyaW9kc0FiYnJldmlhdGVkID0gZ2V0TG9jYWxlRGF5UGVyaW9kcyh0aGlzLmxvY2FsZUlkLCBGb3JtU3R5bGUuRm9ybWF0LCBUcmFuc2xhdGlvbldpZHRoLkFiYnJldmlhdGVkKS5qb2luKCd8Jyk7XHJcbiAgICAgICAgICByZWdleFN0ciA9IHJlZ2V4U3RyLnJlcGxhY2UocGVyaW9kQWJicmV2aWF0ZWQsIGAoJHtwZXJpb2RzQWJicmV2aWF0ZWR9KWApO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMucmVnZXggPSBuZXcgUmVnRXhwKHJlZ2V4U3RyKTtcclxuICB9XHJcbn1cclxuIl19