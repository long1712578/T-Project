import { addDays, addMinutes, differenceInMinutes, endOfDay, isSameSecond, setHours, setMinutes, startOfDay, startOfMinute } from "date-fns";
export var DAYS_OF_WEEK;
(function (DAYS_OF_WEEK) {
    DAYS_OF_WEEK[DAYS_OF_WEEK["SUNDAY"] = 0] = "SUNDAY";
    DAYS_OF_WEEK[DAYS_OF_WEEK["MONDAY"] = 1] = "MONDAY";
    DAYS_OF_WEEK[DAYS_OF_WEEK["TUESDAY"] = 2] = "TUESDAY";
    DAYS_OF_WEEK[DAYS_OF_WEEK["WEDNESDAY"] = 3] = "WEDNESDAY";
    DAYS_OF_WEEK[DAYS_OF_WEEK["THURSDAY"] = 4] = "THURSDAY";
    DAYS_OF_WEEK[DAYS_OF_WEEK["FRIDAY"] = 5] = "FRIDAY";
    DAYS_OF_WEEK[DAYS_OF_WEEK["SATURDAY"] = 6] = "SATURDAY";
})(DAYS_OF_WEEK || (DAYS_OF_WEEK = {}));
const DEFAULT_WEEKEND_DAYS = [
    DAYS_OF_WEEK.SUNDAY,
    DAYS_OF_WEEK.SATURDAY,
];
const DAYS_IN_WEEK = 7;
const HOURS_IN_DAY = 24;
const MINUTES_IN_HOUR = 60;
export const SECONDS_IN_DAY = 60 * 60 * 24;
function sanitiseHours(hours) {
    return Math.max(Math.min(23, hours), 0);
}
function sanitiseMinutes(minutes) {
    return Math.max(Math.min(59, minutes), 0);
}
function getTimezoneOffset(date) {
    return new Date(date).getTimezoneOffset();
}
export function getDayViewHourGrid({ viewDate, hourSegments, hourDuration, dayStart, dayEnd }) {
    const hours = [];
    let startOfView = setMinutes(setHours(startOfDay(viewDate), sanitiseHours(dayStart.hour)), sanitiseMinutes(dayStart.minute));
    let endOfView = setMinutes(setHours(startOfMinute(endOfDay(viewDate)), sanitiseHours(dayEnd.hour)), sanitiseMinutes(dayEnd.minute));
    const segmentDuration = (hourDuration || MINUTES_IN_HOUR) / hourSegments;
    let startOfViewDay = startOfDay(viewDate);
    const endOfViewDay = endOfDay(viewDate);
    let dateAdjustment = (d) => d;
    // this means that we change from or to DST on this day and that's going to cause problems so we bump the date
    if (getTimezoneOffset(startOfViewDay) !==
        getTimezoneOffset(endOfViewDay)) {
        startOfViewDay = addDays(startOfViewDay, 1);
        startOfView = addDays(startOfView, 1);
        endOfView = addDays(endOfView, 1);
        dateAdjustment = (d) => addDays(d, -1);
    }
    const dayDuration = hourDuration
        ? (HOURS_IN_DAY * 60) / hourDuration
        : MINUTES_IN_HOUR;
    for (let i = 0; i < dayDuration; i++) {
        const segments = [];
        for (let j = 0; j < hourSegments; j++) {
            const date = addMinutes(addMinutes(startOfView, i * (hourDuration || MINUTES_IN_HOUR)), j * segmentDuration);
            if (date >= startOfView && date < endOfView) {
                segments.push({
                    date: dateAdjustment(date),
                    displayDate: date,
                    isStart: j === 0,
                });
            }
        }
        if (segments.length > 0) {
            hours.push({ segments });
        }
    }
    return hours;
}
export const trackByHourSegment = (index, segment) => segment.date.toISOString();
function isEventIsPeriod({ event, periodStart, periodEnd }) {
    const eventStart = event.start;
    const eventEnd = event.end || event.start;
    if (eventStart > periodStart && eventStart < periodEnd) {
        return true;
    }
    if (eventEnd > periodStart && eventEnd < periodEnd) {
        return true;
    }
    if (eventStart < periodStart && eventEnd > periodEnd) {
        return true;
    }
    if (isSameSecond(eventStart, periodStart) ||
        isSameSecond(eventStart, periodEnd)) {
        return true;
    }
    if (isSameSecond(eventEnd, periodStart) ||
        isSameSecond(eventEnd, periodEnd)) {
        return true;
    }
    return false;
}
export function getEventsInPeriod({ events, periodStart, periodEnd }) {
    return events.filter((event) => isEventIsPeriod({ event, periodStart, periodEnd }));
}
function getOverLappingWeekViewEvents(events, top, bottom) {
    return events.filter((previousEvent) => {
        const previousEventTop = previousEvent.top;
        const previousEventBottom = previousEvent.top + previousEvent.height;
        if (top < previousEventBottom && previousEventBottom < bottom) {
            return true;
        }
        else if (top < previousEventTop && previousEventTop < bottom) {
            return true;
        }
        else if (previousEventTop <= top && bottom <= previousEventBottom) {
            return true;
        }
        return false;
    });
}
export function getDayView({ events, viewDate, hourSegments, dayStart, dayEnd, eventWidth, segmentHeight, hourDuration, minimumEventHeight }) {
    const startOfView = setMinutes(setHours(startOfDay(viewDate), sanitiseHours(dayStart.hour)), sanitiseMinutes(dayStart.minute));
    const endOfView = setMinutes(setHours(startOfMinute(endOfDay(viewDate)), sanitiseHours(dayEnd.hour)), sanitiseMinutes(dayEnd.minute));
    endOfView.setSeconds(59, 999);
    const previousDayEvents = [];
    const eventsInPeriod = getEventsInPeriod({
        events: events?.filter((event) => !event.allDay),
        periodStart: startOfView,
        periodEnd: endOfView,
    });
    const dayViewEvents = eventsInPeriod
        .sort((eventA, eventB) => {
        return eventA.start.valueOf() - eventB.start.valueOf();
    })
        .map((event) => {
        const eventStart = event.start;
        const eventEnd = event.end || eventStart;
        const startsBeforeDay = eventStart < startOfView;
        const endsAfterDay = eventEnd > endOfView;
        const hourHeightModifier = (hourSegments * segmentHeight) / (hourDuration || MINUTES_IN_HOUR);
        let top = 0;
        if (eventStart > startOfView) {
            // adjust the difference in minutes if the user's offset is different between the start of the day and the event (e.g. when going to or from DST)
            const eventOffset = getTimezoneOffset(eventStart);
            const startOffset = getTimezoneOffset(startOfView);
            const diff = startOffset - eventOffset;
            top += differenceInMinutes(eventStart, startOfView) + diff;
        }
        top *= hourHeightModifier;
        top = Math.floor(top);
        const startDate = startsBeforeDay ? startOfView : eventStart;
        const endDate = endsAfterDay ? endOfView : eventEnd;
        const timezoneOffset = getTimezoneOffset(startDate) -
            getTimezoneOffset(endDate);
        let height = differenceInMinutes(endDate, startDate) + timezoneOffset;
        if (!event.end) {
            height = segmentHeight;
        }
        else {
            height *= hourHeightModifier;
        }
        if (minimumEventHeight && height < minimumEventHeight) {
            height = minimumEventHeight;
        }
        height = Math.floor(height);
        const bottom = top + height;
        const overlappingPreviousEvents = getOverLappingWeekViewEvents(previousDayEvents, top, bottom);
        let left = 0;
        while (overlappingPreviousEvents.some((previousEvent) => previousEvent.left === left)) {
            left += eventWidth;
        }
        const dayEvent = {
            event,
            height,
            width: eventWidth,
            top,
            left,
            startsBeforeDay,
            endsAfterDay,
        };
        previousDayEvents.push(dayEvent);
        return dayEvent;
    });
    const width = Math.max(...dayViewEvents.map((event) => event.left + event.width));
    const allDayEvents = getEventsInPeriod({
        events: events?.filter((event) => event.allDay),
        periodStart: startOfDay(startOfView),
        periodEnd: endOfDay(endOfView),
    });
    return {
        events: dayViewEvents,
        width,
        allDayEvents,
        period: {
            events: eventsInPeriod,
            start: startOfView,
            end: endOfView,
        },
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsZW5kYXIudXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy90ZHMtdWkvY2FsZW5kYXIvY2FsZW5kYXIudXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsbUJBQW1CLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxhQUFhLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFHN0ksTUFBTSxDQUFOLElBQVksWUFRWDtBQVJELFdBQVksWUFBWTtJQUNwQixtREFBVSxDQUFBO0lBQ1YsbURBQVUsQ0FBQTtJQUNWLHFEQUFXLENBQUE7SUFDWCx5REFBYSxDQUFBO0lBQ2IsdURBQVksQ0FBQTtJQUNaLG1EQUFVLENBQUE7SUFDVix1REFBWSxDQUFBO0FBQ2hCLENBQUMsRUFSVyxZQUFZLEtBQVosWUFBWSxRQVF2QjtBQUVELE1BQU0sb0JBQW9CLEdBQWE7SUFDbkMsWUFBWSxDQUFDLE1BQU07SUFDbkIsWUFBWSxDQUFDLFFBQVE7Q0FDeEIsQ0FBQztBQUNGLE1BQU0sWUFBWSxHQUFHLENBQUMsQ0FBQztBQUN2QixNQUFNLFlBQVksR0FBRyxFQUFFLENBQUM7QUFDeEIsTUFBTSxlQUFlLEdBQUcsRUFBRSxDQUFDO0FBQzNCLE1BQU0sQ0FBQyxNQUFNLGNBQWMsR0FBVyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQztBQW1FbkQsU0FBUyxhQUFhLENBQUMsS0FBYTtJQUNoQyxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDNUMsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUFDLE9BQWU7SUFDcEMsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxF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ZVJlZiB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IGFkZERheXMsIGFkZE1pbnV0ZXMsIGRpZmZlcmVuY2VJbk1pbnV0ZXMsIGVuZE9mRGF5LCBpc1NhbWVTZWNvbmQsIHNldEhvdXJzLCBzZXRNaW51dGVzLCBzdGFydE9mRGF5LCBzdGFydE9mTWludXRlIH0gZnJvbSBcImRhdGUtZm5zXCI7XHJcbmltcG9ydCB7IFREU1NhZmVBbnkgfSBmcm9tIFwidGRzLXVpL3NoYXJlZC91dGlsaXR5XCI7XHJcblxyXG5leHBvcnQgZW51bSBEQVlTX09GX1dFRUsge1xyXG4gICAgU1VOREFZID0gMCxcclxuICAgIE1PTkRBWSA9IDEsXHJcbiAgICBUVUVTREFZID0gMixcclxuICAgIFdFRE5FU0RBWSA9IDMsXHJcbiAgICBUSFVSU0RBWSA9IDQsXHJcbiAgICBGUklEQVkgPSA1LFxyXG4gICAgU0FUVVJEQVkgPSA2LFxyXG59XHJcblxyXG5jb25zdCBERUZBVUxUX1dFRUtFTkRfREFZUzogbnVtYmVyW10gPSBbXHJcbiAgICBEQVlTX09GX1dFRUsuU1VOREFZLFxyXG4gICAgREFZU19PRl9XRUVLLlNBVFVSREFZLFxyXG5dO1xyXG5jb25zdCBEQVlTX0lOX1dFRUsgPSA3O1xyXG5jb25zdCBIT1VSU19JTl9EQVkgPSAyNDtcclxuY29uc3QgTUlOVVRFU19JTl9IT1VSID0gNjA7XHJcbmV4cG9ydCBjb25zdCBTRUNPTkRTX0lOX0RBWTogbnVtYmVyID0gNjAgKiA2MCAqIDI0O1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBXZWVrVmlld0hvdXJTZWdtZW50IHtcclxuICAgIGlzU3RhcnQ6IGJvb2xlYW47XHJcbiAgICBkYXRlOiBEYXRlO1xyXG4gICAgZGlzcGxheURhdGU6IERhdGU7XHJcbiAgICBjc3NDbGFzcz86IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBXZWVrVmlld0hvdXIge1xyXG4gICAgc2VnbWVudHM6IFdlZWtWaWV3SG91clNlZ21lbnRbXTtcclxufVxyXG5leHBvcnQgaW50ZXJmYWNlIFREU0NhbmxlbmRhckV2ZW50SW50ZXJmYWNlIHtcclxuICAgIHN0YXJ0OiBEYXRlLFxyXG4gICAgZW5kOiBEYXRlLFxyXG4gICAgZGF0YTogVERTU2FmZUFueTtcclxuICAgIHRlbXBsYXRlOiBzdHJpbmcgfCBUZW1wbGF0ZVJlZjx2b2lkPjtcclxuICAgIGFsbERheT86IGJvb2xlYW5cclxufVxyXG5leHBvcnQgaW50ZXJmYWNlIFREU1dlZWtWaWV3VGltZUV2ZW50IHtcclxuICAgIGV2ZW50OiBURFNDYW5sZW5kYXJFdmVudEludGVyZmFjZTtcclxuICAgIGhlaWdodDogbnVtYmVyO1xyXG4gICAgd2lkdGg6IG51bWJlcjtcclxuICAgIHRvcDogbnVtYmVyO1xyXG4gICAgbGVmdDogbnVtYmVyO1xyXG4gICAgc3RhcnRzQmVmb3JlRGF5OiBib29sZWFuO1xyXG4gICAgZW5kc0FmdGVyRGF5OiBib29sZWFuO1xyXG59XHJcbmV4cG9ydCBpbnRlcmZhY2UgVmlld1BlcmlvZCB7XHJcbiAgICBzdGFydDogRGF0ZTtcclxuICAgIGVuZDogRGF0ZTtcclxuICAgIGV2ZW50czogVERTQ2FubGVuZGFyRXZlbnRJbnRlcmZhY2VbXTtcclxufVxyXG5leHBvcnQgaW50ZXJmYWNlIEdldERheVZpZXdBcmdzIHtcclxuICAgIGV2ZW50cz86IFREU0NhbmxlbmRhckV2ZW50SW50ZXJmYWNlW107XHJcbiAgICB2aWV3RGF0ZTogRGF0ZTtcclxuICAgIGhvdXJTZWdtZW50czogbnVtYmVyO1xyXG4gICAgZGF5U3RhcnQ6IHtcclxuICAgICAgICBob3VyOiBudW1iZXI7XHJcbiAgICAgICAgbWludXRlOiBudW1iZXI7XHJcbiAgICB9O1xyXG4gICAgZGF5RW5kOiB7XHJcbiAgICAgICAgaG91cjogbnVtYmVyO1xyXG4gICAgICAgIG1pbnV0ZTogbnVtYmVyO1xyXG4gICAgfTtcclxuICAgIGV2ZW50V2lkdGg6IG51bWJlcjtcclxuICAgIHNlZ21lbnRIZWlnaHQ6IG51bWJlcjtcclxuICAgIGhvdXJEdXJhdGlvbjogbnVtYmVyO1xyXG4gICAgbWluaW11bUV2ZW50SGVpZ2h0OiBudW1iZXI7XHJcbn1cclxuaW50ZXJmYWNlIFRpbWUge1xyXG4gICAgaG91cjogbnVtYmVyO1xyXG4gICAgbWludXRlOiBudW1iZXI7XHJcbn1cclxuaW50ZXJmYWNlIEdldERheVZpZXdIb3VyR3JpZEFyZ3Mge1xyXG4gICAgdmlld0RhdGU6IERhdGU7XHJcbiAgICBob3VyU2VnbWVudHM6IG51bWJlcjtcclxuICAgIGhvdXJEdXJhdGlvbjogbnVtYmVyO1xyXG4gICAgZGF5U3RhcnQ6IFRpbWU7XHJcbiAgICBkYXlFbmQ6IFRpbWU7XHJcbn1cclxuZXhwb3J0IGludGVyZmFjZSBEYXlWaWV3IHtcclxuICAgIGV2ZW50czogVERTV2Vla1ZpZXdUaW1lRXZlbnRbXTtcclxuICAgIHdpZHRoOiBudW1iZXI7XHJcbiAgICBhbGxEYXlFdmVudHM6IFREU0NhbmxlbmRhckV2ZW50SW50ZXJmYWNlW107XHJcbiAgICBwZXJpb2Q6IFZpZXdQZXJpb2Q7XHJcbn1cclxuZnVuY3Rpb24gc2FuaXRpc2VIb3Vycyhob3VyczogbnVtYmVyKTogbnVtYmVyIHtcclxuICAgIHJldHVybiBNYXRoLm1heChNYXRoLm1pbigyMywgaG91cnMpLCAwKTtcclxufVxyXG5cclxuZnVuY3Rpb24gc2FuaXRpc2VNaW51dGVzKG1pbnV0ZXM6IG51bWJlcik6IG51bWJlciB7XHJcbiAgICByZXR1cm4gTWF0aC5tYXgoTWF0aC5taW4oNTksIG1pbnV0ZXMpLCAwKTtcclxufVxyXG5mdW5jdGlvbiBnZXRUaW1lem9uZU9mZnNldChkYXRlOiBEYXRlIHwgbnVtYmVyKTogbnVtYmVyIHtcclxuICAgIHJldHVybiBuZXcgRGF0ZShkYXRlKS5nZXRUaW1lem9uZU9mZnNldCgpO1xyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiBnZXREYXlWaWV3SG91ckdyaWQoe1xyXG4gICAgdmlld0RhdGUsXHJcbiAgICBob3VyU2VnbWVudHMsXHJcbiAgICBob3VyRHVyYXRpb24sXHJcbiAgICBkYXlTdGFydCxcclxuICAgIGRheUVuZFxyXG59OiBHZXREYXlWaWV3SG91ckdyaWRBcmdzXHJcbik6IFdlZWtWaWV3SG91cltdIHtcclxuICAgIGNvbnN0IGhvdXJzOiBXZWVrVmlld0hvdXJbXSA9IFtdO1xyXG4gICAgbGV0IHN0YXJ0T2ZWaWV3OiBEYXRlID0gc2V0TWludXRlcyhcclxuICAgICAgICBzZXRIb3VycyhzdGFydE9mRGF5KHZpZXdEYXRlKSwgc2FuaXRpc2VIb3VycyhkYXlTdGFydC5ob3VyKSksXHJcbiAgICAgICAgc2FuaXRpc2VNaW51dGVzKGRheVN0YXJ0Lm1pbnV0ZSlcclxuICAgICk7XHJcbiAgICBsZXQgZW5kT2ZWaWV3OiBEYXRlID0gc2V0TWludXRlcyhcclxuICAgICAgICBzZXRIb3VycyhzdGFydE9mTWludXRlKGVuZE9mRGF5KHZpZXdEYXRlKSksIHNhbml0aXNlSG91cnMoZGF5RW5kLmhvdXIpKSxcclxuICAgICAgICBzYW5pdGlzZU1pbnV0ZXMoZGF5RW5kLm1pbnV0ZSlcclxuICAgICk7XHJcbiAgICBjb25zdCBzZWdtZW50RHVyYXRpb246IG51bWJlciA9XHJcbiAgICAgICAgKGhvdXJEdXJhdGlvbiB8fCBNSU5VVEVTX0lOX0hPVVIpIC8gaG91clNlZ21lbnRzO1xyXG4gICAgbGV0IHN0YXJ0T2ZWaWV3RGF5OiBEYXRlID0gc3RhcnRPZkRheSh2aWV3RGF0ZSk7XHJcbiAgICBjb25zdCBlbmRPZlZpZXdEYXk6IERhdGUgPSBlbmRPZkRheSh2aWV3RGF0ZSk7XHJcbiAgICBsZXQgZGF0ZUFkanVzdG1lbnQ6IChkOiBEYXRlKSA9PiBEYXRlID0gKGQ6IERhdGUpID0+IGQ7XHJcblxyXG4gICAgLy8gdGhpcyBtZWFucyB0aGF0IHdlIGNoYW5nZSBmcm9tIG9yIHRvIERTVCBvbiB0aGlzIGRheSBhbmQgdGhhdCdzIGdvaW5nIHRvIGNhdXNlIHByb2JsZW1zIHNvIHdlIGJ1bXAgdGhlIGRhdGVcclxuICAgIGlmIChcclxuICAgICAgICBnZXRUaW1lem9uZU9mZnNldChzdGFydE9mVmlld0RheSkgIT09XHJcbiAgICAgICAgZ2V0VGltZXpvbmVPZmZzZXQoZW5kT2ZWaWV3RGF5KVxyXG4gICAgKSB7XHJcbiAgICAgICAgc3RhcnRPZlZpZXdEYXkgPSBhZGREYXlzKHN0YXJ0T2ZWaWV3RGF5LCAxKTtcclxuICAgICAgICBzdGFydE9mVmlldyA9IGFkZERheXMoc3RhcnRPZlZpZXcsIDEpO1xyXG4gICAgICAgIGVuZE9mVmlldyA9IGFkZERheXMoZW5kT2ZWaWV3LCAxKTtcclxuICAgICAgICBkYXRlQWRqdXN0bWVudCA9IChkOiBEYXRlKSA9PiBhZGREYXlzKGQsIC0xKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBkYXlEdXJhdGlvbjogbnVtYmVyID0gaG91ckR1cmF0aW9uXHJcbiAgICAgICAgPyAoSE9VUlNfSU5fREFZICogNjApIC8gaG91ckR1cmF0aW9uXHJcbiAgICAgICAgOiBNSU5VVEVTX0lOX0hPVVI7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRheUR1cmF0aW9uOyBpKyspIHtcclxuICAgICAgICBjb25zdCBzZWdtZW50czogV2Vla1ZpZXdIb3VyU2VnbWVudFtdID0gW107XHJcbiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBob3VyU2VnbWVudHM7IGorKykge1xyXG4gICAgICAgICAgICBjb25zdCBkYXRlOiBEYXRlID0gYWRkTWludXRlcyhcclxuICAgICAgICAgICAgICAgIGFkZE1pbnV0ZXMoc3RhcnRPZlZpZXcsIGkgKiAoaG91ckR1cmF0aW9uIHx8IE1JTlVURVNfSU5fSE9VUikpLFxyXG4gICAgICAgICAgICAgICAgaiAqIHNlZ21lbnREdXJhdGlvblxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICBpZiAoZGF0ZSA+PSBzdGFydE9mVmlldyAmJiBkYXRlIDwgZW5kT2ZWaWV3KSB7XHJcbiAgICAgICAgICAgICAgICBzZWdtZW50cy5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICBkYXRlOiBkYXRlQWRqdXN0bWVudChkYXRlKSxcclxuICAgICAgICAgICAgICAgICAgICBkaXNwbGF5RGF0ZTogZGF0ZSxcclxuICAgICAgICAgICAgICAgICAgICBpc1N0YXJ0OiBqID09PSAwLFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHNlZ21lbnRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgaG91cnMucHVzaCh7IHNlZ21lbnRzIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gaG91cnM7XHJcbn1cclxuZXhwb3J0IGNvbnN0IHRyYWNrQnlIb3VyU2VnbWVudCA9IChcclxuICAgIGluZGV4OiBudW1iZXIsXHJcbiAgICBzZWdtZW50OiBXZWVrVmlld0hvdXJTZWdtZW50XHJcbikgPT4gc2VnbWVudC5kYXRlLnRvSVNPU3RyaW5nKCk7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEdldEV2ZW50c0luUGVyaW9kQXJncyB7XHJcbiAgICBldmVudHM6IFREU0NhbmxlbmRhckV2ZW50SW50ZXJmYWNlW107XHJcbiAgICBwZXJpb2RTdGFydDogRGF0ZTtcclxuICAgIHBlcmlvZEVuZDogRGF0ZTtcclxufVxyXG5cclxuaW50ZXJmYWNlIElzRXZlbnRJblBlcmlvZEFyZ3Mge1xyXG4gICAgZXZlbnQ6IFREU0NhbmxlbmRhckV2ZW50SW50ZXJmYWNlO1xyXG4gICAgcGVyaW9kU3RhcnQ6IERhdGU7XHJcbiAgICBwZXJpb2RFbmQ6IERhdGU7XHJcbn1cclxuZnVuY3Rpb24gaXNFdmVudElzUGVyaW9kKFxyXG4gICAgeyBldmVudCwgcGVyaW9kU3RhcnQsIHBlcmlvZEVuZCB9OiBJc0V2ZW50SW5QZXJpb2RBcmdzXHJcbik6IGJvb2xlYW4ge1xyXG4gICAgY29uc3QgZXZlbnRTdGFydDogRGF0ZSA9IGV2ZW50LnN0YXJ0O1xyXG4gICAgY29uc3QgZXZlbnRFbmQ6IERhdGUgPSBldmVudC5lbmQgfHwgZXZlbnQuc3RhcnQ7XHJcblxyXG4gICAgaWYgKGV2ZW50U3RhcnQgPiBwZXJpb2RTdGFydCAmJiBldmVudFN0YXJ0IDwgcGVyaW9kRW5kKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGV2ZW50RW5kID4gcGVyaW9kU3RhcnQgJiYgZXZlbnRFbmQgPCBwZXJpb2RFbmQpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZXZlbnRTdGFydCA8IHBlcmlvZFN0YXJ0ICYmIGV2ZW50RW5kID4gcGVyaW9kRW5kKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKFxyXG4gICAgICAgIGlzU2FtZVNlY29uZChldmVudFN0YXJ0LCBwZXJpb2RTdGFydCkgfHxcclxuICAgICAgICBpc1NhbWVTZWNvbmQoZXZlbnRTdGFydCwgcGVyaW9kRW5kKVxyXG4gICAgKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKFxyXG4gICAgICAgIGlzU2FtZVNlY29uZChldmVudEVuZCwgcGVyaW9kU3RhcnQpIHx8XHJcbiAgICAgICAgaXNTYW1lU2Vjb25kKGV2ZW50RW5kLCBwZXJpb2RFbmQpXHJcbiAgICApIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbn1cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEV2ZW50c0luUGVyaW9kKFxyXG5cclxuICAgIHsgZXZlbnRzLCBwZXJpb2RTdGFydCwgcGVyaW9kRW5kIH06IEdldEV2ZW50c0luUGVyaW9kQXJnc1xyXG4pOiBURFNDYW5sZW5kYXJFdmVudEludGVyZmFjZVtdIHtcclxuICAgIHJldHVybiBldmVudHMuZmlsdGVyKChldmVudDogVERTQ2FubGVuZGFyRXZlbnRJbnRlcmZhY2UpID0+XHJcbiAgICAgICAgaXNFdmVudElzUGVyaW9kKHsgZXZlbnQsIHBlcmlvZFN0YXJ0LCBwZXJpb2RFbmQgfSlcclxuICAgICk7XHJcbn1cclxuZnVuY3Rpb24gZ2V0T3ZlckxhcHBpbmdXZWVrVmlld0V2ZW50cyhcclxuICAgIGV2ZW50czogVERTV2Vla1ZpZXdUaW1lRXZlbnRbXSxcclxuICAgIHRvcDogbnVtYmVyLFxyXG4gICAgYm90dG9tOiBudW1iZXJcclxuKTogVERTV2Vla1ZpZXdUaW1lRXZlbnRbXSB7XHJcbiAgICByZXR1cm4gZXZlbnRzLmZpbHRlcigocHJldmlvdXNFdmVudDogVERTV2Vla1ZpZXdUaW1lRXZlbnQpID0+IHtcclxuICAgICAgICBjb25zdCBwcmV2aW91c0V2ZW50VG9wOiBudW1iZXIgPSBwcmV2aW91c0V2ZW50LnRvcDtcclxuICAgICAgICBjb25zdCBwcmV2aW91c0V2ZW50Qm90dG9tOiBudW1iZXIgPVxyXG4gICAgICAgICAgICBwcmV2aW91c0V2ZW50LnRvcCArIHByZXZpb3VzRXZlbnQuaGVpZ2h0O1xyXG5cclxuICAgICAgICBpZiAodG9wIDwgcHJldmlvdXNFdmVudEJvdHRvbSAmJiBwcmV2aW91c0V2ZW50Qm90dG9tIDwgYm90dG9tKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodG9wIDwgcHJldmlvdXNFdmVudFRvcCAmJiBwcmV2aW91c0V2ZW50VG9wIDwgYm90dG9tKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSBpZiAocHJldmlvdXNFdmVudFRvcCA8PSB0b3AgJiYgYm90dG9tIDw9IHByZXZpb3VzRXZlbnRCb3R0b20pIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9KTtcclxufVxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0RGF5VmlldyhcclxuICAgIHtcclxuICAgICAgICBldmVudHMsXHJcbiAgICAgICAgdmlld0RhdGUsXHJcbiAgICAgICAgaG91clNlZ21lbnRzLFxyXG4gICAgICAgIGRheVN0YXJ0LFxyXG4gICAgICAgIGRheUVuZCxcclxuICAgICAgICBldmVudFdpZHRoLFxyXG4gICAgICAgIHNlZ21lbnRIZWlnaHQsXHJcbiAgICAgICAgaG91ckR1cmF0aW9uLFxyXG4gICAgICAgIG1pbmltdW1FdmVudEhlaWdodFxyXG4gICAgfTogR2V0RGF5Vmlld0FyZ3NcclxuKTogRGF5VmlldyB7XHJcblxyXG5cclxuICAgIGNvbnN0IHN0YXJ0T2ZWaWV3OiBEYXRlID0gc2V0TWludXRlcyhcclxuICAgICAgICBzZXRIb3VycyhzdGFydE9mRGF5KHZpZXdEYXRlKSwgc2FuaXRpc2VIb3VycyhkYXlTdGFydC5ob3VyKSksXHJcbiAgICAgICAgc2FuaXRpc2VNaW51dGVzKGRheVN0YXJ0Lm1pbnV0ZSlcclxuICAgICk7XHJcbiAgICBjb25zdCBlbmRPZlZpZXc6IERhdGUgPSBzZXRNaW51dGVzKFxyXG4gICAgICAgIHNldEhvdXJzKHN0YXJ0T2ZNaW51dGUoZW5kT2ZEYXkodmlld0RhdGUpKSwgc2FuaXRpc2VIb3VycyhkYXlFbmQuaG91cikpLFxyXG4gICAgICAgIHNhbml0aXNlTWludXRlcyhkYXlFbmQubWludXRlKVxyXG4gICAgKTtcclxuICAgIGVuZE9mVmlldy5zZXRTZWNvbmRzKDU5LCA5OTkpO1xyXG4gICAgY29uc3QgcHJldmlvdXNEYXlFdmVudHM6IFREU1dlZWtWaWV3VGltZUV2ZW50W10gPSBbXTtcclxuICAgIGNvbnN0IGV2ZW50c0luUGVyaW9kID0gZ2V0RXZlbnRzSW5QZXJpb2Qoe1xyXG4gICAgICAgIGV2ZW50czogZXZlbnRzPy5maWx0ZXIoKGV2ZW50OiBURFNDYW5sZW5kYXJFdmVudEludGVyZmFjZSkgPT4gIWV2ZW50LmFsbERheSkhICxcclxuICAgICAgICBwZXJpb2RTdGFydDogc3RhcnRPZlZpZXcsXHJcbiAgICAgICAgcGVyaW9kRW5kOiBlbmRPZlZpZXcsXHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCBkYXlWaWV3RXZlbnRzOiBURFNXZWVrVmlld1RpbWVFdmVudFtdID0gZXZlbnRzSW5QZXJpb2RcclxuICAgICAgICAuc29ydCgoZXZlbnRBOiBURFNDYW5sZW5kYXJFdmVudEludGVyZmFjZSwgZXZlbnRCOiBURFNDYW5sZW5kYXJFdmVudEludGVyZmFjZSkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gZXZlbnRBLnN0YXJ0LnZhbHVlT2YoKSAtIGV2ZW50Qi5zdGFydC52YWx1ZU9mKCk7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAubWFwKChldmVudDogVERTQ2FubGVuZGFyRXZlbnRJbnRlcmZhY2UpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZXZlbnRTdGFydDogRGF0ZSA9IGV2ZW50LnN0YXJ0O1xyXG4gICAgICAgICAgICBjb25zdCBldmVudEVuZDogRGF0ZSA9IGV2ZW50LmVuZCB8fCBldmVudFN0YXJ0O1xyXG4gICAgICAgICAgICBjb25zdCBzdGFydHNCZWZvcmVEYXk6IGJvb2xlYW4gPSBldmVudFN0YXJ0IDwgc3RhcnRPZlZpZXc7XHJcbiAgICAgICAgICAgIGNvbnN0IGVuZHNBZnRlckRheTogYm9vbGVhbiA9IGV2ZW50RW5kID4gZW5kT2ZWaWV3O1xyXG4gICAgICAgICAgICBjb25zdCBob3VySGVpZ2h0TW9kaWZpZXI6IG51bWJlciA9XHJcbiAgICAgICAgICAgICAgICAoaG91clNlZ21lbnRzICogc2VnbWVudEhlaWdodCkgLyAoaG91ckR1cmF0aW9uIHx8IE1JTlVURVNfSU5fSE9VUik7XHJcblxyXG4gICAgICAgICAgICBsZXQgdG9wID0gMDtcclxuICAgICAgICAgICAgaWYgKGV2ZW50U3RhcnQgPiBzdGFydE9mVmlldykge1xyXG4gICAgICAgICAgICAgICAgLy8gYWRqdXN0IHRoZSBkaWZmZXJlbmNlIGluIG1pbnV0ZXMgaWYgdGhlIHVzZXIncyBvZmZzZXQgaXMgZGlmZmVyZW50IGJldHdlZW4gdGhlIHN0YXJ0IG9mIHRoZSBkYXkgYW5kIHRoZSBldmVudCAoZS5nLiB3aGVuIGdvaW5nIHRvIG9yIGZyb20gRFNUKVxyXG4gICAgICAgICAgICAgICAgY29uc3QgZXZlbnRPZmZzZXQgPSBnZXRUaW1lem9uZU9mZnNldChldmVudFN0YXJ0KTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0T2Zmc2V0ID0gZ2V0VGltZXpvbmVPZmZzZXQoc3RhcnRPZlZpZXcpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGlmZiA9IHN0YXJ0T2Zmc2V0IC0gZXZlbnRPZmZzZXQ7XHJcbiAgICAgICAgICAgICAgICB0b3AgKz0gZGlmZmVyZW5jZUluTWludXRlcyhldmVudFN0YXJ0LCBzdGFydE9mVmlldykgKyBkaWZmO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRvcCAqPSBob3VySGVpZ2h0TW9kaWZpZXI7XHJcbiAgICAgICAgICAgIHRvcCA9IE1hdGguZmxvb3IodG9wKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHN0YXJ0RGF0ZTogRGF0ZSA9IHN0YXJ0c0JlZm9yZURheSA/IHN0YXJ0T2ZWaWV3IDogZXZlbnRTdGFydDtcclxuICAgICAgICAgICAgY29uc3QgZW5kRGF0ZTogRGF0ZSA9IGVuZHNBZnRlckRheSA/IGVuZE9mVmlldyA6IGV2ZW50RW5kO1xyXG4gICAgICAgICAgICBjb25zdCB0aW1lem9uZU9mZnNldCA9XHJcbiAgICAgICAgICAgICAgICBnZXRUaW1lem9uZU9mZnNldChzdGFydERhdGUpIC1cclxuICAgICAgICAgICAgICAgIGdldFRpbWV6b25lT2Zmc2V0KGVuZERhdGUpO1xyXG4gICAgICAgICAgICBsZXQgaGVpZ2h0OiBudW1iZXIgPVxyXG4gICAgICAgICAgICAgICAgZGlmZmVyZW5jZUluTWludXRlcyhlbmREYXRlLCBzdGFydERhdGUpICsgdGltZXpvbmVPZmZzZXQ7XHJcblxyXG4gICAgICAgICAgICBpZiAoIWV2ZW50LmVuZCkge1xyXG4gICAgICAgICAgICAgICAgaGVpZ2h0ID0gc2VnbWVudEhlaWdodDtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGhlaWdodCAqPSBob3VySGVpZ2h0TW9kaWZpZXI7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChtaW5pbXVtRXZlbnRIZWlnaHQgJiYgaGVpZ2h0IDwgbWluaW11bUV2ZW50SGVpZ2h0KSB7XHJcbiAgICAgICAgICAgICAgICBoZWlnaHQgPSBtaW5pbXVtRXZlbnRIZWlnaHQ7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGhlaWdodCA9IE1hdGguZmxvb3IoaGVpZ2h0KTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGJvdHRvbTogbnVtYmVyID0gdG9wICsgaGVpZ2h0O1xyXG5cclxuICAgICAgICAgICAgY29uc3Qgb3ZlcmxhcHBpbmdQcmV2aW91c0V2ZW50cyA9IGdldE92ZXJMYXBwaW5nV2Vla1ZpZXdFdmVudHMoXHJcbiAgICAgICAgICAgICAgICBwcmV2aW91c0RheUV2ZW50cyxcclxuICAgICAgICAgICAgICAgIHRvcCxcclxuICAgICAgICAgICAgICAgIGJvdHRvbVxyXG4gICAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgICAgbGV0IGxlZnQgPSAwO1xyXG5cclxuICAgICAgICAgICAgd2hpbGUgKFxyXG4gICAgICAgICAgICAgICAgb3ZlcmxhcHBpbmdQcmV2aW91c0V2ZW50cy5zb21lKFxyXG4gICAgICAgICAgICAgICAgICAgIChwcmV2aW91c0V2ZW50KSA9PiBwcmV2aW91c0V2ZW50LmxlZnQgPT09IGxlZnRcclxuICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgKSB7XHJcbiAgICAgICAgICAgICAgICBsZWZ0ICs9IGV2ZW50V2lkdGg7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGRheUV2ZW50OiBURFNXZWVrVmlld1RpbWVFdmVudCA9IHtcclxuICAgICAgICAgICAgICAgIGV2ZW50LFxyXG4gICAgICAgICAgICAgICAgaGVpZ2h0LFxyXG4gICAgICAgICAgICAgICAgd2lkdGg6IGV2ZW50V2lkdGgsXHJcbiAgICAgICAgICAgICAgICB0b3AsXHJcbiAgICAgICAgICAgICAgICBsZWZ0LFxyXG4gICAgICAgICAgICAgICAgc3RhcnRzQmVmb3JlRGF5LFxyXG4gICAgICAgICAgICAgICAgZW5kc0FmdGVyRGF5LFxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgcHJldmlvdXNEYXlFdmVudHMucHVzaChkYXlFdmVudCk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gZGF5RXZlbnQ7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgY29uc3Qgd2lkdGg6IG51bWJlciA9IE1hdGgubWF4KFxyXG4gICAgICAgIC4uLmRheVZpZXdFdmVudHMubWFwKChldmVudDogVERTV2Vla1ZpZXdUaW1lRXZlbnQpID0+IGV2ZW50LmxlZnQgKyBldmVudC53aWR0aClcclxuICAgICk7XHJcbiAgICBjb25zdCBhbGxEYXlFdmVudHM6IFREU0NhbmxlbmRhckV2ZW50SW50ZXJmYWNlW10gPSBnZXRFdmVudHNJblBlcmlvZCh7XHJcbiAgICAgICAgZXZlbnRzOiBldmVudHM/LmZpbHRlcigoZXZlbnQ6IFREU0NhbmxlbmRhckV2ZW50SW50ZXJmYWNlKSA9PiBldmVudC5hbGxEYXkpISxcclxuICAgICAgICBwZXJpb2RTdGFydDogc3RhcnRPZkRheShzdGFydE9mVmlldyksXHJcbiAgICAgICAgcGVyaW9kRW5kOiBlbmRPZkRheShlbmRPZlZpZXcpLFxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBldmVudHM6IGRheVZpZXdFdmVudHMsXHJcbiAgICAgICAgd2lkdGgsXHJcbiAgICAgICAgYWxsRGF5RXZlbnRzLFxyXG4gICAgICAgIHBlcmlvZDoge1xyXG4gICAgICAgICAgICBldmVudHM6IGV2ZW50c0luUGVyaW9kLFxyXG4gICAgICAgICAgICBzdGFydDogc3RhcnRPZlZpZXcsXHJcbiAgICAgICAgICAgIGVuZDogZW5kT2ZWaWV3LFxyXG4gICAgICAgIH0sXHJcbiAgICB9O1xyXG59XHJcbiJdfQ==