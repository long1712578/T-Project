import { __decorate } from "tslib";
import { normalizePassiveListenerOptions } from '@angular/cdk/platform';
import { DOCUMENT } from '@angular/common';
import { ChangeDetectionStrategy, Component, EventEmitter, Inject, Input, Output, ViewChild, ViewEncapsulation } from '@angular/core';
import { fromEvent, Subject } from 'rxjs';
import { takeUntil, throttleTime } from 'rxjs/operators';
import { WithConfig } from 'tds-ui/core/config';
import { InputBoolean, InputNumber } from 'tds-ui/shared/utility';
import { getOffsetTop } from './util';
import * as i0 from "@angular/core";
import * as i1 from "tds-ui/core/config";
import * as i2 from "tds-ui/core/services";
import * as i3 from "@angular/cdk/platform";
import * as i4 from "@angular/common";
import * as i5 from "tds-ui/affix";
const _c0 = ["ink"];
function TDSAnchorComponent_tds_affix_0_ng_template_1_Template(rf, ctx) { }
function TDSAnchorComponent_tds_affix_0_Template(rf, ctx) { if (rf & 1) {
    i0.ɵɵelementStart(0, "tds-affix", 2);
    i0.ɵɵtemplate(1, TDSAnchorComponent_tds_affix_0_ng_template_1_Template, 0, 0, "ng-template", 3);
    i0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r0 = i0.ɵɵnextContext();
    const _r1 = i0.ɵɵreference(2);
    i0.ɵɵproperty("offsetTop", ctx_r0.tdsOffsetTop)("tdsTarget", ctx_r0.container);
    i0.ɵɵadvance(1);
    i0.ɵɵproperty("ngTemplateOutlet", _r1);
} }
const _c1 = function (a0) { return { fixed: a0 }; };
function TDSAnchorComponent_ng_template_1_Template(rf, ctx) { if (rf & 1) {
    i0.ɵɵelementStart(0, "div", 4)(1, "div", 5)(2, "div", 6);
    i0.ɵɵelement(3, "div", 7, 8);
    i0.ɵɵelementEnd();
    i0.ɵɵprojection(5);
    i0.ɵɵelementEnd()();
} if (rf & 2) {
    const ctx_r2 = i0.ɵɵnextContext();
    i0.ɵɵproperty("ngStyle", ctx_r2.wrapperStyle);
    i0.ɵɵadvance(1);
    i0.ɵɵproperty("ngClass", i0.ɵɵpureFunction1(2, _c1, !ctx_r2.tdsAffix && !ctx_r2.tdsShowInkInFixed));
} }
const _c2 = ["*"];
const TDS_CONFIG_MODULE_NAME = 'anchor';
const sharpMatcherRegx = /#([^#]+)$/;
const passiveEventListenerOptions = normalizePassiveListenerOptions({ passive: true });
export class TDSAnchorComponent {
    constructor(doc, tdsConfigService, scrollSrv, cdr, platform, zone, renderer) {
        this.doc = doc;
        this.tdsConfigService = tdsConfigService;
        this.scrollSrv = scrollSrv;
        this.cdr = cdr;
        this.platform = platform;
        this.zone = zone;
        this.renderer = renderer;
        this._tdsModuleName = TDS_CONFIG_MODULE_NAME;
        this.tdsAffix = true;
        this.tdsShowInkInFixed = false;
        this.tdsBounds = 5;
        this.tdsOffsetTop = undefined;
        this.tdsTargetOffset = undefined;
        this.tdsClick = new EventEmitter();
        this.tdsChange = new EventEmitter();
        this.tdsScroll = new EventEmitter();
        this.visible = false;
        this.wrapperStyle = { 'max-height': '100vh' };
        this.links = [];
        this.animating = false;
        this.destroy$ = new Subject();
        this.handleScrollTimeoutID = -1;
    }
    registerLink(link) {
        this.links.push(link);
    }
    unregisterLink(link) {
        this.links.splice(this.links.indexOf(link), 1);
    }
    getContainer() {
        return this.container || window;
    }
    ngAfterViewInit() {
        this.registerScrollEvent();
    }
    ngOnDestroy() {
        clearTimeout(this.handleScrollTimeoutID);
        this.destroy$.next();
        this.destroy$.complete();
    }
    registerScrollEvent() {
        if (!this.platform.isBrowser) {
            return;
        }
        this.destroy$.next();
        this.zone.runOutsideAngular(() => {
            fromEvent(this.getContainer(), 'scroll', passiveEventListenerOptions)
                .pipe(throttleTime(50), takeUntil(this.destroy$))
                .subscribe(() => this.handleScroll());
        });
        // Browser would maintain the scrolling position when refreshing.
        // So we have to delay calculation in avoid of getting a incorrect result.
        this.handleScrollTimeoutID = setTimeout(() => this.handleScroll());
    }
    handleScroll() {
        if (typeof document === 'undefined' || this.animating) {
            return;
        }
        const sections = [];
        const offsetTop = this.tdsTargetOffset ? this.tdsTargetOffset : this.tdsOffsetTop || 0;
        const scope = offsetTop + this.tdsBounds;
        this.links.forEach(comp => {
            const sharpLinkMatch = sharpMatcherRegx.exec(comp.tdsHref.toString());
            if (!sharpLinkMatch) {
                return;
            }
            const target = this.doc.getElementById(sharpLinkMatch[1]);
            if (target) {
                const top = getOffsetTop(target, this.getContainer());
                if (top < scope) {
                    sections.push({
                        top,
                        comp
                    });
                }
            }
        });
        this.visible = !!sections.length;
        if (!this.visible) {
            this.clearActive();
            this.cdr.detectChanges();
        }
        else {
            const maxSection = sections.reduce((prev, curr) => (curr.top > prev.top ? curr : prev));
            this.handleActive(maxSection.comp);
        }
        this.setVisible();
    }
    clearActive() {
        this.links.forEach(i => {
            i.unsetActive();
        });
    }
    setActive(comp) {
        const originalActiveLink = this.activeLink;
        const targetComp = (this.tdsCurrentAnchor && this.links.find(n => n.tdsHref === this.tdsCurrentAnchor)) || comp;
        if (!targetComp)
            return;
        targetComp.setActive();
        const linkNode = targetComp.getLinkTitleElement();
        this.ink.nativeElement.style.top = `${linkNode.offsetTop + linkNode.clientHeight / 2 - 4.5}px`;
        this.activeLink = (comp || targetComp).tdsHref;
        if (originalActiveLink !== this.activeLink) {
            this.tdsChange.emit(this.activeLink);
        }
    }
    handleActive(comp) {
        this.clearActive();
        this.setActive(comp);
        this.visible = true;
        this.setVisible();
        this.tdsScroll.emit(comp);
    }
    setVisible() {
        const visible = this.visible;
        const visibleClassname = 'visible';
        if (this.ink) {
            if (visible) {
                this.renderer.addClass(this.ink.nativeElement, visibleClassname);
            }
            else {
                this.renderer.removeClass(this.ink.nativeElement, visibleClassname);
            }
        }
    }
    handleScrollTo(linkComp) {
        const el = this.doc.querySelector(linkComp.tdsHref);
        if (!el) {
            return;
        }
        this.animating = true;
        const containerScrollTop = this.scrollSrv.getScroll(this.getContainer());
        const elOffsetTop = getOffsetTop(el, this.getContainer());
        let targetScrollTop = containerScrollTop + elOffsetTop;
        targetScrollTop -= this.tdsTargetOffset !== undefined ? this.tdsTargetOffset : this.tdsOffsetTop || 0;
        this.scrollSrv.scrollTo(this.getContainer(), targetScrollTop, {
            callback: () => {
                this.animating = false;
                this.handleActive(linkComp);
            }
        });
        this.tdsClick.emit(linkComp.tdsHref);
    }
    ngOnChanges(changes) {
        const { tdsOffsetTop, tdsContainer, tdsCurrentAnchor } = changes;
        if (tdsOffsetTop) {
            this.wrapperStyle = {
                'max-height': `calc(100vh - ${this.tdsOffsetTop}px)`
            };
        }
        if (tdsContainer) {
            const container = this.tdsContainer;
            this.container = typeof container === 'string' ? this.doc.querySelector(container) : container;
            this.registerScrollEvent();
        }
        if (tdsCurrentAnchor) {
            this.setActive();
        }
    }
}
TDSAnchorComponent.ɵfac = function TDSAnchorComponent_Factory(t) { return new (t || TDSAnchorComponent)(i0.ɵɵdirectiveInject(DOCUMENT), i0.ɵɵdirectiveInject(i1.TDSConfigService), i0.ɵɵdirectiveInject(i2.TDSScrollService), i0.ɵɵdirectiveInject(i0.ChangeDetectorRef), i0.ɵɵdirectiveInject(i3.Platform), i0.ɵɵdirectiveInject(i0.NgZone), i0.ɵɵdirectiveInject(i0.Renderer2)); };
TDSAnchorComponent.ɵcmp = /*@__PURE__*/ i0.ɵɵdefineComponent({ type: TDSAnchorComponent, selectors: [["tds-anchor"]], viewQuery: function TDSAnchorComponent_Query(rf, ctx) { if (rf & 1) {
        i0.ɵɵviewQuery(_c0, 5);
    } if (rf & 2) {
        let _t;
        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.ink = _t.first);
    } }, inputs: { tdsAffix: "tdsAffix", tdsShowInkInFixed: "tdsShowInkInFixed", tdsBounds: "tdsBounds", tdsOffsetTop: "tdsOffsetTop", tdsTargetOffset: "tdsTargetOffset", tdsContainer: "tdsContainer", tdsCurrentAnchor: "tdsCurrentAnchor" }, outputs: { tdsClick: "tdsClick", tdsChange: "tdsChange", tdsScroll: "tdsScroll" }, exportAs: ["tdsAnchor"], features: [i0.ɵɵNgOnChangesFeature], ngContentSelectors: _c2, decls: 3, vars: 2, consts: [[3, "offsetTop", "tdsTarget", 4, "ngIf", "ngIfElse"], ["content", ""], [3, "offsetTop", "tdsTarget"], [3, "ngTemplateOutlet"], [1, "tds-anchor-wrapper", 3, "ngStyle"], [1, "tds-anchor", "flex", "flex-col", "border-l", "border-neutral-2-100", "dark:border-d-neutral-2-100", 3, "ngClass"], [1, "tds-anchor-ink"], [1, "tds-anchor-ink-ball"], ["ink", ""]], template: function TDSAnchorComponent_Template(rf, ctx) { if (rf & 1) {
        i0.ɵɵprojectionDef();
        i0.ɵɵtemplate(0, TDSAnchorComponent_tds_affix_0_Template, 2, 3, "tds-affix", 0);
        i0.ɵɵtemplate(1, TDSAnchorComponent_ng_template_1_Template, 6, 4, "ng-template", null, 1, i0.ɵɵtemplateRefExtractor);
    } if (rf & 2) {
        const _r1 = i0.ɵɵreference(2);
        i0.ɵɵproperty("ngIf", ctx.tdsAffix)("ngIfElse", _r1);
    } }, directives: [i4.NgIf, i5.TDSAffixComponent, i4.NgTemplateOutlet, i4.NgStyle, i4.NgClass], encapsulation: 2, changeDetection: 0 });
__decorate([
    InputBoolean()
], TDSAnchorComponent.prototype, "tdsAffix", void 0);
__decorate([
    WithConfig(),
    InputBoolean()
], TDSAnchorComponent.prototype, "tdsShowInkInFixed", void 0);
__decorate([
    WithConfig(),
    InputNumber()
], TDSAnchorComponent.prototype, "tdsBounds", void 0);
__decorate([
    InputNumber(undefined),
    WithConfig()
], TDSAnchorComponent.prototype, "tdsOffsetTop", void 0);
__decorate([
    InputNumber(undefined),
    WithConfig()
], TDSAnchorComponent.prototype, "tdsTargetOffset", void 0);
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(TDSAnchorComponent, [{
        type: Component,
        args: [{
                selector: 'tds-anchor',
                exportAs: 'tdsAnchor',
                preserveWhitespaces: false,
                template: `
    <tds-affix *ngIf="tdsAffix; else content" [offsetTop]="tdsOffsetTop!" [tdsTarget]="container">
      <ng-template [ngTemplateOutlet]="content"></ng-template>
    </tds-affix>
    <ng-template #content>
      <div class="tds-anchor-wrapper " [ngStyle]="wrapperStyle">
        <div class="tds-anchor flex flex-col border-l border-neutral-2-100 dark:border-d-neutral-2-100" [ngClass]="{ fixed: !tdsAffix && !tdsShowInkInFixed }">
          <div class="tds-anchor-ink">
            <div class="tds-anchor-ink-ball" #ink></div>
          </div>
          <ng-content></ng-content>
        </div>
      </div>
    </ng-template>
   
   `,
                encapsulation: ViewEncapsulation.None,
                changeDetection: ChangeDetectionStrategy.OnPush
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [DOCUMENT]
            }] }, { type: i1.TDSConfigService }, { type: i2.TDSScrollService }, { type: i0.ChangeDetectorRef }, { type: i3.Platform }, { type: i0.NgZone }, { type: i0.Renderer2 }]; }, { ink: [{
            type: ViewChild,
            args: ['ink', { static: false }]
        }], tdsAffix: [{
            type: Input
        }], tdsShowInkInFixed: [{
            type: Input
        }], tdsBounds: [{
            type: Input
        }], tdsOffsetTop: [{
            type: Input
        }], tdsTargetOffset: [{
            type: Input
        }], tdsContainer: [{
            type: Input
        }], tdsCurrentAnchor: [{
            type: Input
        }], tdsClick: [{
            type: Output
        }], tdsChange: [{
            type: Output
        }], tdsScroll: [{
            type: Output
        }] }); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5jaG9yLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL3Rkcy11aS9hbmNob3IvYW5jaG9yLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBTUEsT0FBTyxFQUFFLCtCQUErQixFQUFZLE1BQU0sdUJBQXVCLENBQUM7QUFDakYsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFFTCx1QkFBdUIsRUFFdkIsU0FBUyxFQUVULFlBQVksRUFDWixNQUFNLEVBQ04sS0FBSyxFQUlMLE1BQU0sRUFHTixTQUFTLEVBQ1QsaUJBQWlCLEVBQ2xCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUQsT0FBTyxFQUFvRCxVQUFVLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUVsRyxPQUFPLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBYyxNQUFNLHVCQUF1QixDQUFDO0FBRzdFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxRQUFRLENBQUM7Ozs7Ozs7Ozs7SUFpQm5DLG9DQUE4RjtJQUM1RiwrRkFBd0Q7SUFDMUQsaUJBQVk7Ozs7SUFGOEIsK0NBQTJCLCtCQUFBO0lBQ3RELGVBQTRCO0lBQTVCLHNDQUE0Qjs7OztJQUd6Qyw4QkFBMEQsYUFBQSxhQUFBO0lBR3BELDRCQUE0QztJQUM5QyxpQkFBTTtJQUNOLGtCQUF5QjtJQUMzQixpQkFBTSxFQUFBOzs7SUFOeUIsNkNBQXdCO0lBQ3lDLGVBQXNEO0lBQXRELG1HQUFzRDs7O0FBZjdKLE1BQU0sc0JBQXNCLEdBQWlCLFFBQVEsQ0FBQztBQUN0RCxNQUFNLGdCQUFnQixHQUFHLFdBQVcsQ0FBQztBQUVyQyxNQUFNLDJCQUEyQixH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QkFBcEIsS0FBSztZQUNHLGdCQUFnQjtrQkFBeEIsS0FBSztZQUVhLFFBQVE7a0JBQTFCLE1BQU07WUFDWSxTQUFTO2tCQUEzQixNQUFNO1lBQ1ksU0FBUztrQkFBM0IsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxyXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9ORy1aT1JSTy9uZy16b3Jyby1hbnRkL2Jsb2IvbWFzdGVyL0xJQ0VOU0VcclxuICovXHJcblxyXG4gaW1wb3J0IHsgQm9vbGVhbklucHV0LCBOdW1iZXJJbnB1dCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9jb2VyY2lvbic7XHJcbmltcG9ydCB7IG5vcm1hbGl6ZVBhc3NpdmVMaXN0ZW5lck9wdGlvbnMsIFBsYXRmb3JtIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3BsYXRmb3JtJztcclxuIGltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcclxuIGltcG9ydCB7XHJcbiAgIEFmdGVyVmlld0luaXQsXHJcbiAgIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxyXG4gICBDaGFuZ2VEZXRlY3RvclJlZixcclxuICAgQ29tcG9uZW50LFxyXG4gICBFbGVtZW50UmVmLFxyXG4gICBFdmVudEVtaXR0ZXIsXHJcbiAgIEluamVjdCxcclxuICAgSW5wdXQsXHJcbiAgIE5nWm9uZSxcclxuICAgT25DaGFuZ2VzLFxyXG4gICBPbkRlc3Ryb3ksXHJcbiAgIE91dHB1dCxcclxuICAgUmVuZGVyZXIyLFxyXG4gICBTaW1wbGVDaGFuZ2VzLFxyXG4gICBWaWV3Q2hpbGQsXHJcbiAgIFZpZXdFbmNhcHN1bGF0aW9uXHJcbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG4gaW1wb3J0IHsgZnJvbUV2ZW50LCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbiBpbXBvcnQgeyB0YWtlVW50aWwsIHRocm90dGxlVGltZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgTmdTdHlsZUludGVyZmFjZSwgVERTQ29uZmlnS2V5LCBURFNDb25maWdTZXJ2aWNlLCBXaXRoQ29uZmlnIH0gZnJvbSAndGRzLXVpL2NvcmUvY29uZmlnJztcclxuaW1wb3J0IHsgVERTU2Nyb2xsU2VydmljZSB9IGZyb20gJ3Rkcy11aS9jb3JlL3NlcnZpY2VzJztcclxuaW1wb3J0IHsgSW5wdXRCb29sZWFuLCBJbnB1dE51bWJlciwgVERTU2FmZUFueSB9IGZyb20gJ3Rkcy11aS9zaGFyZWQvdXRpbGl0eSc7XHJcbmltcG9ydCB7IFREU0FuY2hvckxpbmtDb21wb25lbnQgfSBmcm9tICcuL2FuY2hvci1saW5rLmNvbXBvbmVudCc7XHJcbiBcclxuIGltcG9ydCB7IGdldE9mZnNldFRvcCB9IGZyb20gJy4vdXRpbCc7XHJcbiBcclxuIGludGVyZmFjZSBTZWN0aW9uIHtcclxuICAgY29tcDogVERTQW5jaG9yTGlua0NvbXBvbmVudDtcclxuICAgdG9wOiBudW1iZXI7XHJcbiB9XHJcbiBcclxuIGNvbnN0IFREU19DT05GSUdfTU9EVUxFX05BTUU6IFREU0NvbmZpZ0tleSA9ICdhbmNob3InO1xyXG4gY29uc3Qgc2hhcnBNYXRjaGVyUmVneCA9IC8jKFteI10rKSQvO1xyXG4gXHJcbiBjb25zdCBwYXNzaXZlRXZlbnRMaXN0ZW5lck9wdGlvbnMgPSBub3JtYWxpemVQYXNzaXZlTGlzdGVuZXJPcHRpb25zKHsgcGFzc2l2ZTogdHJ1ZSB9KTtcclxuIFxyXG4gQENvbXBvbmVudCh7XHJcbiAgIHNlbGVjdG9yOiAndGRzLWFuY2hvcicsXHJcbiAgIGV4cG9ydEFzOiAndGRzQW5jaG9yJyxcclxuICAgcHJlc2VydmVXaGl0ZXNwYWNlczogZmFsc2UsXHJcbiAgIHRlbXBsYXRlOiBgXHJcbiAgICA8dGRzLWFmZml4ICpuZ0lmPVwidGRzQWZmaXg7IGVsc2UgY29udGVudFwiIFtvZmZzZXRUb3BdPVwidGRzT2Zmc2V0VG9wIVwiIFt0ZHNUYXJnZXRdPVwiY29udGFpbmVyXCI+XHJcbiAgICAgIDxuZy10ZW1wbGF0ZSBbbmdUZW1wbGF0ZU91dGxldF09XCJjb250ZW50XCI+PC9uZy10ZW1wbGF0ZT5cclxuICAgIDwvdGRzLWFmZml4PlxyXG4gICAgPG5nLXRlbXBsYXRlICNjb250ZW50PlxyXG4gICAgICA8ZGl2IGNsYXNzPVwidGRzLWFuY2hvci13cmFwcGVyIFwiIFtuZ1N0eWxlXT1cIndyYXBwZXJTdHlsZVwiPlxyXG4gICAgICAgIDxkaXYgY2xhc3M9XCJ0ZHMtYW5jaG9yIGZsZXggZmxleC1jb2wgYm9yZGVyLWwgYm9yZGVyLW5ldXRyYWwtMi0xMDAgZGFyazpib3JkZXItZC1uZXV0cmFsLTItMTAwXCIgW25nQ2xhc3NdPVwieyBmaXhlZDogIXRkc0FmZml4ICYmICF0ZHNTaG93SW5rSW5GaXhlZCB9XCI+XHJcbiAgICAgICAgICA8ZGl2IGNsYXNzPVwidGRzLWFuY2hvci1pbmtcIj5cclxuICAgICAgICAgICAgPGRpdiBjbGFzcz1cInRkcy1hbmNob3ItaW5rLWJhbGxcIiAjaW5rPjwvZGl2PlxyXG4gICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgICA8bmctY29udGVudD48L25nLWNvbnRlbnQ+XHJcbiAgICAgICAgPC9kaXY+XHJcbiAgICAgIDwvZGl2PlxyXG4gICAgPC9uZy10ZW1wbGF0ZT5cclxuICAgXHJcbiAgIGAsXHJcbiAgIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmUsXHJcbiAgIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoXHJcbiB9KVxyXG4gZXhwb3J0IGNsYXNzIFREU0FuY2hvckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uRGVzdHJveSwgQWZ0ZXJWaWV3SW5pdCwgT25DaGFuZ2VzIHtcclxuICAgcmVhZG9ubHkgX3Rkc01vZHVsZU5hbWU6IFREU0NvbmZpZ0tleSA9IFREU19DT05GSUdfTU9EVUxFX05BTUU7XHJcbiAgIHN0YXRpYyBuZ0FjY2VwdElucHV0VHlwZV90ZHNBZmZpeDogQm9vbGVhbklucHV0O1xyXG4gICBzdGF0aWMgbmdBY2NlcHRJbnB1dFR5cGVfdGRzU2hvd0lua0luRml4ZWQ6IEJvb2xlYW5JbnB1dDtcclxuICAgc3RhdGljIG5nQWNjZXB0SW5wdXRUeXBlX3Rkc0JvdW5kczogTnVtYmVySW5wdXQ7XHJcbiAgIHN0YXRpYyBuZ0FjY2VwdElucHV0VHlwZV90ZHNPZmZzZXRUb3A6IE51bWJlcklucHV0O1xyXG4gXHJcbiAgIEBWaWV3Q2hpbGQoJ2luaycsIHsgc3RhdGljOiBmYWxzZSB9KSBwcml2YXRlIGluayE6IEVsZW1lbnRSZWY7XHJcbiBcclxuICAgQElucHV0KCkgQElucHV0Qm9vbGVhbigpIHRkc0FmZml4ID0gdHJ1ZTtcclxuIFxyXG4gICBASW5wdXQoKVxyXG4gICBAV2l0aENvbmZpZygpXHJcbiAgIEBJbnB1dEJvb2xlYW4oKVxyXG4gICB0ZHNTaG93SW5rSW5GaXhlZDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gXHJcbiAgIEBJbnB1dCgpXHJcbiAgIEBXaXRoQ29uZmlnKClcclxuICAgQElucHV0TnVtYmVyKClcclxuICAgdGRzQm91bmRzOiBudW1iZXIgPSA1O1xyXG4gXHJcbiAgIEBJbnB1dCgpXHJcbiAgIEBJbnB1dE51bWJlcih1bmRlZmluZWQpXHJcbiAgIEBXaXRoQ29uZmlnPG51bWJlcj4oKVxyXG4gICB0ZHNPZmZzZXRUb3A/OiBudW1iZXIgPSB1bmRlZmluZWQ7XHJcbiBcclxuICAgQElucHV0KClcclxuICAgQElucHV0TnVtYmVyKHVuZGVmaW5lZClcclxuICAgQFdpdGhDb25maWc8bnVtYmVyPigpXHJcbiAgIHRkc1RhcmdldE9mZnNldD86IG51bWJlciA9IHVuZGVmaW5lZDtcclxuIFxyXG4gICBASW5wdXQoKSB0ZHNDb250YWluZXI/OiBzdHJpbmcgfCBIVE1MRWxlbWVudDtcclxuICAgQElucHV0KCkgdGRzQ3VycmVudEFuY2hvcj86IHN0cmluZztcclxuIFxyXG4gICBAT3V0cHV0KCkgcmVhZG9ubHkgdGRzQ2xpY2sgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcclxuICAgQE91dHB1dCgpIHJlYWRvbmx5IHRkc0NoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xyXG4gICBAT3V0cHV0KCkgcmVhZG9ubHkgdGRzU2Nyb2xsID0gbmV3IEV2ZW50RW1pdHRlcjxURFNBbmNob3JMaW5rQ29tcG9uZW50PigpO1xyXG4gXHJcbiAgIHZpc2libGUgPSBmYWxzZTtcclxuICAgd3JhcHBlclN0eWxlOiBOZ1N0eWxlSW50ZXJmYWNlID0geyAnbWF4LWhlaWdodCc6ICcxMDB2aCcgfTtcclxuIFxyXG4gICBjb250YWluZXI/OiBIVE1MRWxlbWVudCB8IFdpbmRvdztcclxuICAgYWN0aXZlTGluaz86IHN0cmluZztcclxuIFxyXG4gICBwcml2YXRlIGxpbmtzOiBURFNBbmNob3JMaW5rQ29tcG9uZW50W10gPSBbXTtcclxuICAgcHJpdmF0ZSBhbmltYXRpbmcgPSBmYWxzZTtcclxuICAgcHJpdmF0ZSBkZXN0cm95JCA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgIHByaXZhdGUgaGFuZGxlU2Nyb2xsVGltZW91dElEID0gLTE7XHJcbiBcclxuICAgY29uc3RydWN0b3IoXHJcbiAgICAgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSBkb2M6IFREU1NhZmVBbnksXHJcbiAgICAgcHVibGljIHRkc0NvbmZpZ1NlcnZpY2U6IFREU0NvbmZpZ1NlcnZpY2UsXHJcbiAgICAgcHJpdmF0ZSBzY3JvbGxTcnY6IFREU1Njcm9sbFNlcnZpY2UsXHJcbiAgICAgcHJpdmF0ZSBjZHI6IENoYW5nZURldGVjdG9yUmVmLFxyXG4gICAgIHByaXZhdGUgcGxhdGZvcm06IFBsYXRmb3JtLFxyXG4gICAgIHByaXZhdGUgem9uZTogTmdab25lLFxyXG4gICAgIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMlxyXG4gICApIHt9XHJcbiBcclxuICAgcmVnaXN0ZXJMaW5rKGxpbms6IFREU0FuY2hvckxpbmtDb21wb25lbnQpOiB2b2lkIHtcclxuICAgICB0aGlzLmxpbmtzLnB1c2gobGluayk7XHJcbiAgIH1cclxuIFxyXG4gICB1bnJlZ2lzdGVyTGluayhsaW5rOiBURFNBbmNob3JMaW5rQ29tcG9uZW50KTogdm9pZCB7XHJcbiAgICAgdGhpcy5saW5rcy5zcGxpY2UodGhpcy5saW5rcy5pbmRleE9mKGxpbmspLCAxKTtcclxuICAgfVxyXG4gXHJcbiAgIHByaXZhdGUgZ2V0Q29udGFpbmVyKCk6IEhUTUxFbGVtZW50IHwgV2luZG93IHtcclxuICAgICByZXR1cm4gdGhpcy5jb250YWluZXIgfHwgd2luZG93O1xyXG4gICB9XHJcbiBcclxuICAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xyXG4gICAgIHRoaXMucmVnaXN0ZXJTY3JvbGxFdmVudCgpO1xyXG4gICB9XHJcbiBcclxuICAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICAgY2xlYXJUaW1lb3V0KHRoaXMuaGFuZGxlU2Nyb2xsVGltZW91dElEKTtcclxuICAgICB0aGlzLmRlc3Ryb3kkLm5leHQoKTtcclxuICAgICB0aGlzLmRlc3Ryb3kkLmNvbXBsZXRlKCk7XHJcbiAgIH1cclxuIFxyXG4gICBwcml2YXRlIHJlZ2lzdGVyU2Nyb2xsRXZlbnQoKTogdm9pZCB7XHJcbiAgICAgaWYgKCF0aGlzLnBsYXRmb3JtLmlzQnJvd3Nlcikge1xyXG4gICAgICAgcmV0dXJuO1xyXG4gICAgIH1cclxuICAgICB0aGlzLmRlc3Ryb3kkLm5leHQoKTtcclxuICAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xyXG4gICAgICAgZnJvbUV2ZW50KHRoaXMuZ2V0Q29udGFpbmVyKCksICdzY3JvbGwnLCA8QWRkRXZlbnRMaXN0ZW5lck9wdGlvbnM+cGFzc2l2ZUV2ZW50TGlzdGVuZXJPcHRpb25zKVxyXG4gICAgICAgICAucGlwZSh0aHJvdHRsZVRpbWUoNTApLCB0YWtlVW50aWwodGhpcy5kZXN0cm95JCkpXHJcbiAgICAgICAgIC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5oYW5kbGVTY3JvbGwoKSk7XHJcbiAgICAgfSk7XHJcbiAgICAgLy8gQnJvd3NlciB3b3VsZCBtYWludGFpbiB0aGUgc2Nyb2xsaW5nIHBvc2l0aW9uIHdoZW4gcmVmcmVzaGluZy5cclxuICAgICAvLyBTbyB3ZSBoYXZlIHRvIGRlbGF5IGNhbGN1bGF0aW9uIGluIGF2b2lkIG9mIGdldHRpbmcgYSBpbmNvcnJlY3QgcmVzdWx0LlxyXG4gICAgIHRoaXMuaGFuZGxlU2Nyb2xsVGltZW91dElEID0gc2V0VGltZW91dCgoKSA9PiB0aGlzLmhhbmRsZVNjcm9sbCgpKTtcclxuICAgfVxyXG4gXHJcbiAgIGhhbmRsZVNjcm9sbCgpOiB2b2lkIHtcclxuICAgICBpZiAodHlwZW9mIGRvY3VtZW50ID09PSAndW5kZWZpbmVkJyB8fCB0aGlzLmFuaW1hdGluZykge1xyXG4gICAgICAgcmV0dXJuO1xyXG4gICAgIH1cclxuIFxyXG4gICAgIGNvbnN0IHNlY3Rpb25zOiBTZWN0aW9uW10gPSBbXTtcclxuICAgICBjb25zdCBvZmZzZXRUb3AgPSB0aGlzLnRkc1RhcmdldE9mZnNldCA/IHRoaXMudGRzVGFyZ2V0T2Zmc2V0IDogdGhpcy50ZHNPZmZzZXRUb3AgfHwgMDtcclxuICAgICBjb25zdCBzY29wZSA9IG9mZnNldFRvcCArIHRoaXMudGRzQm91bmRzOyAgICAgXHJcbiAgICAgdGhpcy5saW5rcy5mb3JFYWNoKGNvbXAgPT4ge1xyXG4gICAgICAgY29uc3Qgc2hhcnBMaW5rTWF0Y2ggPSBzaGFycE1hdGNoZXJSZWd4LmV4ZWMoY29tcC50ZHNIcmVmLnRvU3RyaW5nKCkpO1xyXG4gICAgICAgaWYgKCFzaGFycExpbmtNYXRjaCkge1xyXG4gICAgICAgICByZXR1cm47XHJcbiAgICAgICB9XHJcbiAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmRvYy5nZXRFbGVtZW50QnlJZChzaGFycExpbmtNYXRjaFsxXSk7XHJcbiAgICAgICBpZiAodGFyZ2V0KSB7XHJcbiAgICAgICAgIGNvbnN0IHRvcCA9IGdldE9mZnNldFRvcCh0YXJnZXQsIHRoaXMuZ2V0Q29udGFpbmVyKCkpO1xyXG4gICAgICAgICBpZiAodG9wIDwgc2NvcGUpIHtcclxuICAgICAgICAgICBzZWN0aW9ucy5wdXNoKHtcclxuICAgICAgICAgICAgIHRvcCxcclxuICAgICAgICAgICAgIGNvbXBcclxuICAgICAgICAgICB9KTtcclxuICAgICAgICAgfVxyXG4gICAgICAgfVxyXG4gICAgIH0pO1xyXG4gXHJcbiAgICAgdGhpcy52aXNpYmxlID0gISFzZWN0aW9ucy5sZW5ndGg7XHJcbiAgICAgaWYgKCF0aGlzLnZpc2libGUpIHtcclxuICAgICAgIHRoaXMuY2xlYXJBY3RpdmUoKTtcclxuICAgICAgIHRoaXMuY2RyLmRldGVjdENoYW5nZXMoKTtcclxuICAgICB9IGVsc2Uge1xyXG4gICAgICAgY29uc3QgbWF4U2VjdGlvbiA9IHNlY3Rpb25zLnJlZHVjZSgocHJldiwgY3VycikgPT4gKGN1cnIudG9wID4gcHJldi50b3AgPyBjdXJyIDogcHJldikpO1xyXG4gICAgICAgdGhpcy5oYW5kbGVBY3RpdmUobWF4U2VjdGlvbi5jb21wKTtcclxuICAgICB9XHJcbiAgICAgdGhpcy5zZXRWaXNpYmxlKCk7XHJcbiAgIH1cclxuIFxyXG4gICBwcml2YXRlIGNsZWFyQWN0aXZlKCk6IHZvaWQge1xyXG4gICAgIHRoaXMubGlua3MuZm9yRWFjaChpID0+IHtcclxuICAgICAgIGkudW5zZXRBY3RpdmUoKTtcclxuICAgICB9KTtcclxuICAgfVxyXG4gXHJcbiAgIHByaXZhdGUgc2V0QWN0aXZlKGNvbXA/OiBURFNBbmNob3JMaW5rQ29tcG9uZW50KTogdm9pZCB7XHJcblxyXG4gICAgIGNvbnN0IG9yaWdpbmFsQWN0aXZlTGluayA9IHRoaXMuYWN0aXZlTGluaztcclxuICAgICBjb25zdCB0YXJnZXRDb21wID0gKHRoaXMudGRzQ3VycmVudEFuY2hvciAmJiB0aGlzLmxpbmtzLmZpbmQobiA9PiBuLnRkc0hyZWYgPT09IHRoaXMudGRzQ3VycmVudEFuY2hvcikpIHx8IGNvbXA7XHJcbiAgICAgaWYgKCF0YXJnZXRDb21wKSByZXR1cm47XHJcbiBcclxuICAgICB0YXJnZXRDb21wLnNldEFjdGl2ZSgpO1xyXG4gICAgIGNvbnN0IGxpbmtOb2RlID0gdGFyZ2V0Q29tcC5nZXRMaW5rVGl0bGVFbGVtZW50KCk7XHJcbiAgICAgdGhpcy5pbmsubmF0aXZlRWxlbWVudC5zdHlsZS50b3AgPSBgJHtsaW5rTm9kZS5vZmZzZXRUb3AgKyBsaW5rTm9kZS5jbGllbnRIZWlnaHQgLyAyIC0gNC41fXB4YDtcclxuICAgICB0aGlzLmFjdGl2ZUxpbmsgPSAoY29tcCB8fCB0YXJnZXRDb21wKS50ZHNIcmVmO1xyXG4gICAgIGlmIChvcmlnaW5hbEFjdGl2ZUxpbmsgIT09IHRoaXMuYWN0aXZlTGluaykge1xyXG4gICAgICAgdGhpcy50ZHNDaGFuZ2UuZW1pdCh0aGlzLmFjdGl2ZUxpbmspO1xyXG4gICAgIH1cclxuICAgfVxyXG4gXHJcbiAgIHByaXZhdGUgaGFuZGxlQWN0aXZlKGNvbXA6IFREU0FuY2hvckxpbmtDb21wb25lbnQpOiB2b2lkIHtcclxuICAgICB0aGlzLmNsZWFyQWN0aXZlKCk7XHJcbiAgICAgdGhpcy5zZXRBY3RpdmUoY29tcCk7XHJcbiAgICAgdGhpcy52aXNpYmxlID0gdHJ1ZTtcclxuICAgICB0aGlzLnNldFZpc2libGUoKTtcclxuICAgICB0aGlzLnRkc1Njcm9sbC5lbWl0KGNvbXApO1xyXG4gICB9XHJcbiBcclxuICAgcHJpdmF0ZSBzZXRWaXNpYmxlKCk6IHZvaWQge1xyXG4gICAgIGNvbnN0IHZpc2libGUgPSB0aGlzLnZpc2libGU7XHJcbiAgICAgY29uc3QgdmlzaWJsZUNsYXNzbmFtZSA9ICd2aXNpYmxlJztcclxuICAgICBpZiAodGhpcy5pbmspIHtcclxuICAgICAgIGlmICh2aXNpYmxlKSB7XHJcbiAgICAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3ModGhpcy5pbmsubmF0aXZlRWxlbWVudCwgdmlzaWJsZUNsYXNzbmFtZSk7XHJcbiAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKHRoaXMuaW5rLm5hdGl2ZUVsZW1lbnQsIHZpc2libGVDbGFzc25hbWUpO1xyXG4gICAgICAgfVxyXG4gICAgIH1cclxuICAgfVxyXG4gXHJcbiAgIGhhbmRsZVNjcm9sbFRvKGxpbmtDb21wOiBURFNBbmNob3JMaW5rQ29tcG9uZW50KTogdm9pZCB7XHJcbiAgICAgY29uc3QgZWwgPSB0aGlzLmRvYy5xdWVyeVNlbGVjdG9yKGxpbmtDb21wLnRkc0hyZWYpO1xyXG4gICAgIGlmICghZWwpIHtcclxuICAgICAgIHJldHVybjtcclxuICAgICB9XHJcbiBcclxuICAgICB0aGlzLmFuaW1hdGluZyA9IHRydWU7XHJcbiAgICAgY29uc3QgY29udGFpbmVyU2Nyb2xsVG9wID0gdGhpcy5zY3JvbGxTcnYuZ2V0U2Nyb2xsKHRoaXMuZ2V0Q29udGFpbmVyKCkpO1xyXG4gICAgIGNvbnN0IGVsT2Zmc2V0VG9wID0gZ2V0T2Zmc2V0VG9wKGVsLCB0aGlzLmdldENvbnRhaW5lcigpKTtcclxuICAgICBsZXQgdGFyZ2V0U2Nyb2xsVG9wID0gY29udGFpbmVyU2Nyb2xsVG9wICsgZWxPZmZzZXRUb3A7XHJcbiAgICAgdGFyZ2V0U2Nyb2xsVG9wIC09IHRoaXMudGRzVGFyZ2V0T2Zmc2V0ICE9PSB1bmRlZmluZWQgPyB0aGlzLnRkc1RhcmdldE9mZnNldCA6IHRoaXMudGRzT2Zmc2V0VG9wIHx8IDA7XHJcbiAgICAgdGhpcy5zY3JvbGxTcnYuc2Nyb2xsVG8odGhpcy5nZXRDb250YWluZXIoKSwgdGFyZ2V0U2Nyb2xsVG9wLCB7XHJcbiAgICAgICBjYWxsYmFjazogKCkgPT4ge1xyXG4gICAgICAgICB0aGlzLmFuaW1hdGluZyA9IGZhbHNlO1xyXG4gICAgICAgICB0aGlzLmhhbmRsZUFjdGl2ZShsaW5rQ29tcCk7XHJcbiAgICAgICB9XHJcbiAgICAgfSk7XHJcbiAgICAgdGhpcy50ZHNDbGljay5lbWl0KGxpbmtDb21wLnRkc0hyZWYpO1xyXG4gICB9XHJcbiBcclxuICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG4gICAgIGNvbnN0IHsgdGRzT2Zmc2V0VG9wLCB0ZHNDb250YWluZXIsIHRkc0N1cnJlbnRBbmNob3IgfSA9IGNoYW5nZXM7XHJcbiAgICAgaWYgKHRkc09mZnNldFRvcCkge1xyXG4gICAgICAgdGhpcy53cmFwcGVyU3R5bGUgPSB7XHJcbiAgICAgICAgICdtYXgtaGVpZ2h0JzogYGNhbGMoMTAwdmggLSAke3RoaXMudGRzT2Zmc2V0VG9wfXB4KWBcclxuICAgICAgIH07XHJcbiAgICAgfVxyXG4gICAgIGlmICh0ZHNDb250YWluZXIpIHtcclxuICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMudGRzQ29udGFpbmVyO1xyXG4gICAgICAgdGhpcy5jb250YWluZXIgPSB0eXBlb2YgY29udGFpbmVyID09PSAnc3RyaW5nJyA/IHRoaXMuZG9jLnF1ZXJ5U2VsZWN0b3IoY29udGFpbmVyKSA6IGNvbnRhaW5lcjtcclxuICAgICAgIHRoaXMucmVnaXN0ZXJTY3JvbGxFdmVudCgpO1xyXG4gICAgIH1cclxuICAgICBpZiAodGRzQ3VycmVudEFuY2hvcikge1xyXG4gICAgICAgdGhpcy5zZXRBY3RpdmUoKTtcclxuICAgICB9XHJcbiAgIH1cclxuIH1cclxuICJdfQ==